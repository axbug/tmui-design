var e=Object.defineProperty,t=Object.defineProperties,l=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,l,i)=>l in t?e(t,l,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[l]=i,n=(e,t)=>{for(var l in t||(t={}))o.call(t,l)&&a(e,l,t[l]);if(i)for(var l of i(t))s.call(t,l)&&a(e,l,t[l]);return e},u=(e,i)=>t(e,l(i)),r=(e,t,l)=>(a(e,"symbol"!=typeof t?t+"":t,l),l),f=(e,t,l)=>new Promise(((i,o)=>{var s=e=>{try{n(l.next(e))}catch(t){o(t)}},a=e=>{try{n(l.throw(e))}catch(t){o(t)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,a);n((l=l.apply(e,t)).next())}));import{V as d,aC as c,aD as p,d as m,c as h,r as y,P as g,Q as x,o as v,a as b,w as C,b as w,e as S,f as F,F as _,u as A,n as P,M as j,j as k,g as z,aE as V,i as N,N as T,U as D}from"./index-6b165856.js";import{_ as O}from"./tm-image.vue_vue_type_script_setup_true_lang.b0e5c126.js";import{t as U}from"./tm-text.6c910eb0.js";import{t as B}from"./tm-icon.65b53dc0.js";import{t as I}from"./tm-sheet.3639b36a.js";var $=(e=>(e[e.upload=0]="upload",e[e.uploading=1]="uploading",e[e.fail=2]="fail",e[e.success=3]="success",e[e.max=4]="max",e))($||{});function E(e=3){return Number(Number(Math.random().toString().substr(3,e)+Date.now()).toString(8))}class L{constructor(e){var t;r(this,"filelist",[]),r(this,"isStop",!1),r(this,"index",0),r(this,"config",{}),r(this,"uploadobj",null);let l={maxSize:10485760,maxFile:9,fileType:["album","camera"],fileList:[],autoUpload:!0,header:{},formData:{},formName:"file"};l=n(n({},l),null!=(t=arguments[0])?t:{}),this.config=l,this.addFile(l.fileList),delete this.config.fileList}beforeChooesefile(){return f(this,null,(function*(){return!0}))}chooesefileAfter(e){return f(this,null,(function*(){return e}))}chooesefileSuccess(e){return f(this,null,(function*(){return e}))}delete(e){let t=this.filelist.findIndex((t=>t.uid==e.uid));if(t>-1){let e=[...this.filelist];e.splice(t,1),this.filelist=[...e]}return this.filelist}clear(){return f(this,null,(function*(){this.stop(),this.filelist=[]}))}setFileStatus(e){let t=this.filelist.findIndex((t=>t.uid==e.uid));if(t>-1){let l=[...this.filelist];l.splice(t,1,e),this.filelist=[...l]}}chooesefile(){return f(this,null,(function*(){let e=this;return new Promise(((t,l)=>f(this,null,(function*(){(yield e.beforeChooesefile())?d({count:e.config.maxFile,sourceType:e.config.fileType,fail:e=>{l("取消选择")},success:i=>f(this,null,(function*(){if(0==i.tempFilePaths.length)return void l("未选择");let o=i.tempFilePaths,s=i.tempFiles,a=[];o.forEach(((t,l)=>{var i;let o=s[l].size>e.config.maxSize;a.push({url:t,status:o?"超过大小":"待上传",progress:o?100:0,uid:E(),statusCode:o?4:0,response:null,name:null!=(i=s[l].name)?i:""})}));let n=yield e.chooesefileAfter(a);Array.isArray(n)&&"object"==typeof n?(e.filelist.push(...n),e.chooesefileSuccess(n),t(n),e.config.autoUpload&&setTimeout((function(){e.start()}),500)):l("chooesefileAfter:函数过滤，没有返回文件列表。")}))}):t([])}))))}))}chooseMPH5weixinFile(){return f(this,null,(function*(){let e=this;return new Promise(((t,l)=>{var i,o=c,s={count:e.config.maxfile,type:e.config.type,extension:e.config.extension};e.config.extension&&Array.isArray(e.config.extension)&&0!=(null==(i=e.config.extension)?void 0:i.length)||delete s.extension,o(u(n({},s),{fail:e=>{console.error(e),uni.$tm.toast("已取消选择"),l(e)},success:l=>{if(0==l.tempFiles.length)return void uni.$tm.toast("未选择");let i=l.tempFiles,o=[];i.forEach(((t,l)=>{let s=i[l].size>e.config.maxsize,a=t.name||"";a&&(a=a.substr(a.lastIndexOf(".")+1).toLocaleLowerCase()),o.push({url:t.path,name:t.name||"默认文件名称",type:a,status:s?"超过大小":"待上传",progress:s?100:0,fileId:guid(),statusCode:s?4:0,data:null})})),e.filelist.push(...o),e.selected(e.filelist),e.config.isAuto&&e.start(),t(e.filelist)}}))}))}))}setConfig(e){this.config=n(n({},this.config),null!=e?e:{})}addFile(e=[]){if("object"!=typeof e&&!Array.isArray(e))return;let t=new Set(this.filelist.map((e=>e.uid))),l=new Set(this.filelist.map((e=>e.url))),i=e.map((e=>{var t,l,i,o,s,a,r;return u(n({},e),{status:null!=(t=null==e?void 0:e.status)?t:"待上传",statusCode:null!=(l=null==e?void 0:e.statusCode)?l:0,uid:null!=(i=null==e?void 0:e.uid)?i:E(),progress:null!=(o=null==e?void 0:e.progress)?o:0,name:null!=(s=null==e?void 0:e.name)?s:"",response:null!=(a=null==e?void 0:e.response)?a:null,url:null!=(r=null==e?void 0:e.url)?r:""})})).filter((e=>!t.has(e.uid)&&!l.has(e.url)));this.filelist.push(...i)}beforeSuccess(e){return Promise.resolve(!0)}beforeStart(e){return Promise.resolve(!0)}progress(e){}fail(e){}success(e,t){}complete(e){}uploadComplete(e){}awaitTime(){return new Promise((e=>{setTimeout((()=>{e(!0)}),20)}))}start(){return f(this,null,(function*(){if(this.filelist.length<=0)return void console.error("未选择图片,已取消上传");let e=this;this.index=0,this.isStop=!1,yield function t(){return f(this,null,(function*(){var l,i,o,s;if(e.isStop)return;let a=e.filelist[e.index];if(!a||void 0===a)return void e.uploadComplete(e.filelist);if(!(yield e.beforeStart(a)))return a.statusCode=2,a.status="不允许上传",e.filelist.splice(e.index,1,a),e.index++,e.setFileStatus(a),e.fail(a),e.complete(a),void t();if(3==a.statusCode||1==a.statusCode||4==a.statusCode||2==a.statusCode)return e.index++,void t();a.statusCode=1,a.status="上传中...",e.setFileStatus(a);const u=e.uploadobj=p({url:String(e.config.hostUrl),name:null!=(i=null==(l=e.config)?void 0:l.formName)?i:"file",header:null!=(s=null==(o=e.config)?void 0:o.header)?s:{},filePath:a.url,formData:n({name:a.name},e.config.formData),success:t=>f(this,null,(function*(){var l,i;if(e.isStop)return;a.response=t.data;let o=yield e.beforeSuccess(a);const s=null!=(i=null==(l=e.config)?void 0:l.statusCode)?i:200;if(t.statusCode!=s||!o)return a.statusCode=2,a.status="上传失败",e.fail(a),e.setFileStatus(a),void e.index++;a.statusCode=3,a.status="上传成功",e.setFileStatus(a),e.success(a,e.filelist),e.index++})),fail:t=>{e.isStop||(a.statusCode=2,a.status="上传失败",e.setFileStatus(a),e.fail(a),e.index++)},complete:l=>f(this,null,(function*(){e.isStop||(yield e.awaitTime(),e.complete(a),t())}))});if(u){let t=e.filelist[e.index];u.onProgressUpdate((l=>f(this,null,(function*(){e.isStop||(t.progress=l.progress,t.statusCode=1,t.status="上传中...",e.setFileStatus(t),e.progress(t))}))))}}))}()}))}stop(){this.isStop=!0,null!=this.uploadobj&&this.uploadobj.abort()}}const M=m({__name:"tm-upload",props:{followTheme:{type:[Boolean,String],default:!0},width:{type:Number,default:700},rows:{type:Number,default:5},imageHeight:{type:Number,default:140},imageModel:{type:String,default:"scaleToFill"},defaultValue:{type:Array,default:()=>[]},modelValue:{type:Array,default:()=>[]},color:{type:String,default:"primary"},header:{type:Object,default:()=>{}},formData:{type:Object,default:()=>{}},maxFile:{type:Number,default:9},maxSize:{type:Number,default:10485760},url:{type:String,default:"",required:!0},formName:{type:String,default:"file"},autoUpload:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},onRemove:{type:[Function,Boolean],default:()=>e=>!0},onStart:{type:[Function,Boolean],default:()=>e=>!0},onSuccessAfter:{type:[Function,Boolean],default:()=>e=>!0},beforeChooese:{type:[Function,Boolean],default:()=>e=>!0},chooesefileAfter:{type:[Function,Boolean],default:()=>e=>!0},showSort:{type:Boolean,default:!1},fileType:{type:Array,default:["album","camera"]},statusCode:{type:Number,default:200},showStatus:{type:Boolean,default:!0}},emits:["success","fail","complete","change","remove","uploadComplete","update:modelValue"],setup(e,{expose:t,emit:l}){var i;const o=e;null==(i=z())||i.proxy;let s=NaN;const a=h((()=>o.width/o.rows)),u=h((()=>o.imageHeight)),r=new L({formName:o.formName,hostUrl:o.url,autoUpload:o.autoUpload,fileList:E(o.defaultValue),header:o.header,formData:o.formData,maxFile:o.maxFile,maxSize:o.maxSize,fileType:o.fileType,statusCode:o.statusCode}),d=y([]),c=h((()=>o.disabled)),p=h((()=>o.disabled||d.value.length>=o.maxFile));function m(e,t,i){if(0==t&&"prev"==i||t==d.value.length-1&&"next"==i)return;let o="prev"==i?t-1:t+1,s=g(d.value[t]),a=g(d.value[o]),n=uni.$tm.u.deepClone(g(r.filelist));n.splice(t,1,a),n.splice(o,1,s),r.filelist=[...n],d.value=[...r.filelist],l("update:modelValue",n)}function E(e=[]){return e.map((e=>{var t,l,i;let o={url:""};return"string"==typeof e?o.url=e:o=n({},e),o=n({statusCode:null!=(t=null==e?void 0:e.statusCode)?t:$.success,status:null!=(l=null==e?void 0:e.status)?l:"上传成功",progress:null!=(i=null==e?void 0:e.progress)?i:100},o),o}))}function M(){c.value||r.chooesefile().then((e=>{d.value=[...r.filelist],l("update:modelValue",r.filelist)}))}return l("update:modelValue",E(o.defaultValue)),d.value=[...r.filelist],uni.$tm.u.deepClone(g(r.filelist)),x([()=>o.header,()=>o.maxFile,()=>o.maxSize,()=>o.formData],(()=>{r.setConfig({formName:o.formName,hostUrl:o.url,header:o.header,formData:o.formData,maxFile:o.maxFile,maxSize:o.maxSize})}),{deep:!0}),r.beforeChooesefile=function(){return f(this,null,(function*(){if(r.setConfig({maxFile:o.maxFile-r.filelist.length}),"function"==typeof o.beforeChooese){let e=yield o.beforeChooese();if("function"==typeof e&&(e=yield e()),!e)return!1}return!0}))},r.chooesefileAfter=function(e){return f(this,null,(function*(){let t=uni.$tm.u.deepClone(e);if("function"==typeof o.chooesefileAfter){let e=yield o.chooesefileAfter(t);return"function"==typeof e&&(e=yield e(t)),e}return t}))},r.beforeSuccess=function(e){return f(this,null,(function*(){if("function"==typeof o.onSuccessAfter){let t=yield o.onSuccessAfter(e);if("function"==typeof t&&(t=yield t(e)),!t)return!1}return!0}))},r.beforeStart=function(e){return f(this,null,(function*(){if("function"==typeof o.onStart){let t=yield o.onStart(e);if("function"==typeof t&&(t=yield t(e)),!t)return!1}return!0}))},r.complete=function(e){d.value=[...r.filelist]},x((()=>o.modelValue),(()=>{clearTimeout(s);let e=V(o.modelValue)?g(o.modelValue):o.modelValue;s=setTimeout((function(){let t=Array.isArray(e)?e:[];if(r.clear(),0==t.length)r.filelist=[],d.value=[];else{let e=E(t);r.addFile(e);let l=uni.$tm.u.deepClone(r.filelist);d.value=[...l]}}),100)}),{deep:!0}),r.uploadComplete=function(e){l("uploadComplete",e),l("update:modelValue",r.filelist)},r.success=function(e,t){let i=uni.$tm.u.deepClone(r.filelist);l("success",g(e),i),l("change",i)},r.fail=function(e){let t=uni.$tm.u.deepClone(r.filelist);l("fail",g(e),t),l("change",t)},t({start:()=>r.start(),stop:()=>r.stop(),clear:function(){r.clear(),r.filelist=[],d.value=[],l("update:modelValue",[])},del:function(e){let t=r.filelist.findIndex((t=>t.uid==e));if(t>-1){const e=r.filelist[t];r.delete(e),d.value=d.value.splice(t,1),l("remove",g(e)),l("update:modelValue",r.filelist),l("change",g(r.filelist))}},getFailList:function(){return r.filelist.filter((e=>e.statusCode!=$.fail&&e.statusCode!=$.max))},clearFail:function(){const e=r.filelist.filter((e=>e.statusCode!=$.fail&&e.statusCode!=$.max));d.value=[...e],l("update:modelValue",r.filelist)}}),(t,i)=>{const s=N;return v(),b(s,{class:"flex flex-col flex-col-top-start"},{default:C((()=>[w(s,{class:"flex flex-row flex-row-top-start relative",style:P([{"flex-wrap":"wrap"},{width:e.width+"rpx"}])},{default:C((()=>[(v(!0),S(_,null,F(d.value,((e,t)=>(v(),b(s,{class:"ma-5",key:t,style:P({width:A(a)-10+"rpx"})},{default:C((()=>[w(I,{round:2,color:o.color,text:"",transprent:!0,padding:[0,0],margin:[0,0],class:""},{default:C((()=>[w(O,{preview:"",round:2,allowDelete:!1,onDelete:t=>function(e){return f(this,null,(function*(){if("function"==typeof o.onRemove){let t=yield o.onRemove(e);if("function"==typeof t&&(t=yield t(e)),!t)return!1}r.delete(e),d.value=[...r.filelist],l("remove",g(e)),l("update:modelValue",r.filelist),l("change",g(r.filelist))}))}(e),extra:"",delete:!A(c),src:e.url,width:A(a)-10,extraPosition:"in",height:A(u)-10,model:o.imageModel},{extra:C((()=>[!A(c)&&o.showStatus?(v(),b(s,{key:0,style:P({background:"rgba(0, 0, 0, 0.5)",width:A(a)-10+"rpx"}),class:T([["round-b-2"],"py-4 px-4 flex flex-row flex-row-center-start"])},{default:C((()=>[0==e.statusCode||1==e.statusCode?(v(),b(B,{key:0,"font-size":23,color:"grey-3",name:"tmicon-clock-fill"})):k("v-if",!0),0==e.statusCode||1==e.statusCode?(v(),b(U,{key:1,color:"grey-3",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):k("v-if",!0),2==e.statusCode||4==e.statusCode?(v(),b(B,{key:2,"font-size":23,color:"red",name:"tmicon-times-circle-fill"})):k("v-if",!0),2==e.statusCode||4==e.statusCode?(v(),b(U,{key:3,color:"red",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):k("v-if",!0),3==e.statusCode?(v(),b(B,{key:4,"font-size":23,color:"green",name:"tmicon-check-circle-fill"})):k("v-if",!0),3==e.statusCode?(v(),b(U,{key:5,color:"green",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):k("v-if",!0)])),_:2},1032,["style"])):k("v-if",!0),o.showSort?(v(),b(s,{key:1,class:"absolute l-0 t-0 flex flex-row flex-row-center-between flex-1",style:P({width:A(a)-10+"rpx",height:"44rpx",top:(A(u)-44)/2+"rpx"})},{default:C((()=>[w(s,{onClick:D((e=>m(0,t,"prev")),["stop"]),class:T([[0==t?"opacity-0":""],"flex flex-row flex-row-center-center px-12 py-4 round-tr-12 round-br-12"]),style:P({background:"rgba(0, 0, 0, 0.5)"})},{default:C((()=>[w(B,{userInteractionEnabled:!1,color:"white","font-size":22,name:"tmicon-angle-left"})])),_:2},1032,["onClick","class","style"]),w(s,{onClick:D((e=>m(0,t,"next")),["stop"]),class:T([[t==d.value.length-1?"opacity-0":""],"flex flex-row flex-row-center-center px-12 py-4 round-tl-12 round-bl-12"]),style:P({background:"rgba(0, 0, 0, 0.5)"})},{default:C((()=>[w(B,{userInteractionEnabled:!1,color:"white","font-size":22,name:"tmicon-angle-right"})])),_:2},1032,["onClick","class","style"])])),_:2},1032,["style"])):k("v-if",!0)])),_:2},1032,["onDelete","delete","src","width","height","model"])])),_:2},1032,["color"])])),_:2},1032,["style"])))),128)),A(p)?k("v-if",!0):(v(),b(s,{key:0,onClick:M,class:"ma-5",style:P({width:A(a)-10+"rpx"})},{default:C((()=>[w(I,{eventPenetrationEnabled:!0,followTheme:o.followTheme,round:2,color:o.color,text:"",padding:[0,0],margin:[0,0],_class:"flex-center",height:A(u)-10},{default:C((()=>[j(t.$slots,"icon",{},(()=>[w(B,{"font-size":42,userInteractionEnabled:!1,name:"tmicon-plus"})]))])),_:3},8,["followTheme","color","height"])])),_:3},8,["style"]))])),_:3},8,["style"])])),_:3})}}});export{M as _};
