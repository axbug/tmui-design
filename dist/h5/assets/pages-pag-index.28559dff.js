import{d as t,p as e,G as i,o as r,a as s,n,g as a,H as o,w as h,b as l}from"./index-5c06cf16.js";import{t as d}from"./tm-app.20954b06.js";import{g as c}from"./getCanvas.fd5c9d3a.js";let u;try{u=performance.now.bind(performance)}catch(Ze){u=Date.now}class m{constructor(){this.startTime=u(),this.markers={}}reset(){this.startTime=u(),this.markers={}}mark(t){t?Object.keys(this.markers).find((e=>e===t))?console.log(`Clock.mark(): The specified marker name '${t}' already exists!`):this.markers[t]=u():console.log("Clock.mark(): An empty marker name was specified!")}measure(t,e){let i,r;if(t){if(!Object.keys(this.markers).find((e=>e===t)))return console.log(`Clock.measure(): The specified makerFrom '${t}' does not exist!`),0;i=this.markers[t]}else i=this.startTime;if(e){if(!Object.keys(this.markers).find((t=>t===e)))return console.log(`Clock.measure(): The specified makerTo '${e}' does not exist!`),0;r=this.markers[e]}else r=u();return r-i}}var p=(t=>(t[t.Unknown=0]="Unknown",t[t.Vector=1]="Vector",t[t.Bitmap=2]="Bitmap",t[t.Video=3]="Video",t))(p||{}),f=(t=>(t[t.End=0]="End",t[t.FontTables=1]="FontTables",t[t.VectorCompositionBlock=2]="VectorCompositionBlock",t[t.CompositionAttributes=3]="CompositionAttributes",t[t.ImageTables=4]="ImageTables",t[t.LayerBlock=5]="LayerBlock",t[t.LayerAttributes=6]="LayerAttributes",t[t.SolidColor=7]="SolidColor",t[t.TextSource=8]="TextSource",t[t.TextPathOption=9]="TextPathOption",t[t.TextMoreOption=10]="TextMoreOption",t[t.ImageReference=11]="ImageReference",t[t.CompositionReference=12]="CompositionReference",t[t.Transform2D=13]="Transform2D",t[t.MaskBlock=14]="MaskBlock",t[t.ShapeGroup=15]="ShapeGroup",t[t.Rectangle=16]="Rectangle",t[t.Ellipse=17]="Ellipse",t[t.PolyStar=18]="PolyStar",t[t.ShapePath=19]="ShapePath",t[t.Fill=20]="Fill",t[t.Stroke=21]="Stroke",t[t.GradientFill=22]="GradientFill",t[t.GradientStroke=23]="GradientStroke",t[t.MergePaths=24]="MergePaths",t[t.TrimPaths=25]="TrimPaths",t[t.Repeater=26]="Repeater",t[t.RoundCorners=27]="RoundCorners",t[t.Performance=28]="Performance",t[t.DropShadowStyle=29]="DropShadowStyle",t[t.InnerShadowStyle=30]="InnerShadowStyle",t[t.OuterGlowStyle=31]="OuterGlowStyle",t[t.InnerGlowStyle=32]="InnerGlowStyle",t[t.BevelAndEmbossStyle=33]="BevelAndEmbossStyle",t[t.SatinStyle=34]="SatinStyle",t[t.ColorOverlayStyle=35]="ColorOverlayStyle",t[t.GradientOverlayStyle=36]="GradientOverlayStyle",t[t.StrokeStyle=37]="StrokeStyle",t[t.TintEffect=38]="TintEffect",t[t.FillEffect=39]="FillEffect",t[t.StrokeEffect=40]="StrokeEffect",t[t.TritoneEffect=41]="TritoneEffect",t[t.DropShadowEffect=42]="DropShadowEffect",t[t.RadialWipeEffect=43]="RadialWipeEffect",t[t.DisplacementMapEffect=44]="DisplacementMapEffect",t[t.BitmapCompositionBlock=45]="BitmapCompositionBlock",t[t.BitmapSequence=46]="BitmapSequence",t[t.ImageBytes=47]="ImageBytes",t[t.ImageBytes2=48]="ImageBytes2",t[t.ImageBytes3=49]="ImageBytes3",t[t.VideoCompositionBlock=50]="VideoCompositionBlock",t[t.VideoSequence=51]="VideoSequence",t[t.LayerAttributesV2=52]="LayerAttributesV2",t[t.Count=53]="Count",t))(f||{});const g=t=>{const e=t.readUint16();let i=(63&e)>>>0;const r=e>>6;return 63===i&&(i=t.readUint32()),t.context.tagLevel<r&&(t.context.tagLevel=r),{code:r,length:i}};function y(t,e,i){let r=g(t);for(;r.code!==f.End;){const s=t.readBytes(r.length);i(s,r.code,e),t.context.tagLevel<s.context.tagLevel&&(t.context.tagLevel=s.context.tagLevel),r=g(t)}}const w={alpha:!0,depth:!1,stencil:!1,antialias:!1};var v=(t=>(t[t.Normal=0]="Normal",t[t.Multiply=1]="Multiply",t[t.Screen=2]="Screen",t[t.Overlay=3]="Overlay",t[t.Darken=4]="Darken",t[t.Lighten=5]="Lighten",t[t.ColorDodge=6]="ColorDodge",t[t.ColorBurn=7]="ColorBurn",t[t.HardLight=8]="HardLight",t[t.SoftLight=9]="SoftLight",t[t.Difference=10]="Difference",t[t.Exclusion=11]="Exclusion",t[t.Hue=12]="Hue",t[t.Saturation=13]="Saturation",t[t.Color=14]="Color",t[t.Luminosity=15]="Luminosity",t[t.DestinationIn=21]="DestinationIn",t[t.DestinationOut=22]="DestinationOut",t[t.DestinationATop=23]="DestinationATop",t[t.SourceIn=24]="SourceIn",t[t.SourceOut=25]="SourceOut",t[t.Xor=26]="Xor",t))(v||{}),b=(t=>(t[t.None=0]="None",t[t.Linear=1]="Linear",t[t.Bezier=2]="Bezier",t[t.Hold=3]="Hold",t))(b||{});const x=navigator&&/(ios|ipad|iphone)/.test(navigator.userAgent.toLowerCase()),S={red:0,green:0,blue:0},E={red:255,green:255,blue:255},T=()=>{console.error("PAG Verify Failed!")},R=t=>!!t||(console.error("PAG Verify Failed!"),!1),P=class{constructor(){this.id=0,this.width=0,this.height=0,this.duration=0,this.frameRate=30,this.backgroundColor=E,this.cacheID=0,this.cacheID=P.cacheIDCount,P.cacheIDCount+=1}type(){return p.Unknown}getStaticTimeRanges(){return[]}verify(){return R(this.width>0&&this.height>0&&this.duration>0&&this.frameRate>0)}};let C=P;C.cacheIDCount=1;class A extends C{constructor(){super(...arguments),this.hasAlpha=!1,this.sequences=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return p.Video}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}updateStaticTimeRanges(){if(!(this.duration<=1))if(this.sequences.length>0){let t=this.sequences[0];for(let i=1;i<this.sequences.length;i++){const e=this.sequences[i];e.frameRate>t.frameRate&&(t=e)}const e=this.frameRate/t.frameRate;for(const i of t.staticTimeRanges)i.start=Math.round(i.start*e),i.end=Math.round(i.end*e),this.staticTimeRanges.push(i)}else{const t={start:0,end:this.duration-1};this.staticTimeRanges.push(t)}}hasImageContent(){return!0}verify(){if(!super.verify()||this.sequences.length<=0)return T(),!1;for(const t of this.sequences)if(!t||!t.verify())return T(),!1;return!0}}class V{constructor(t,e){this.numerator=1,this.denominator=1,this.numerator=t,this.denominator=e}value(){return this.numerator/this.denominator}}const k=new V(1,1);class _{constructor(t,e){this.x=t,this.y=e}}const B=new _(0,0);var U=(t=>(t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.AlphaInverted=2]="AlphaInverted",t[t.Luma=3]="Luma",t[t.LumaInverted=4]="LumaInverted",t))(U||{}),L=(t=>(t[t.Unknown=0]="Unknown",t[t[void 0]=1]="undefined",t[t.Solid=2]="Solid",t[t.Text=3]="Text",t[t.Shape=4]="Shape",t[t.Image=5]="Image",t[t.PreCompose=6]="PreCompose",t))(L||{});class F{constructor(){this.id=0,this.parent=void 0,this.containingComposition=void 0,this.stretch=k,this.startTime=0,this.duration=0,this.autoOrientation=!1,this.transform=void 0,this.isActive=!0,this.blendMode=v.Normal,this.trackMatteType=0,this.trackMatteLayer=void 0,this.timeRemap=void 0,this.masks=void 0,this.effects=void 0,this.layerStyles=void 0,this.layerCache=void 0,this.maxScale=void 0}type(){return 0}excludeVaryingRanges(t){var e;if(null==(e=this.transform)||e.excludeVaryingRanges(t),void 0!==this.timeRemap&&this.timeRemap.excludeVaryingRanges(t),void 0!==this.masks)for(const i of this.masks)i.excludeVaryingRanges(t);if(void 0!==this.effects&&this.effects.length>0)for(const i of this.effects)i.excludeVaryingRanges(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const i of this.layerStyles)i.excludeVaryingRanges(t)}gotoFrame(t){var e;if(null==(e=this.transform)||e.gotoFrame(t),void 0!==this.timeRemap&&this.timeRemap.gotoFrame(t),void 0!==this.masks&&this.masks.length>0)for(const i of this.masks)i.gotoFrame(t);if(void 0!==this.effects&&this.effects.length>0)for(const i of this.effects)i.gotoFrame(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const i of this.layerStyles)i.gotoFrame(t)}verify(){if(!this.containingComposition||this.duration<=0||!this.transform)return T(),!1;if(!this.transform.verify())return T(),!1;if(this.masks&&this.masks.length>0)for(const t of this.masks)if(!t||!t.verify())return T(),!1;if(this.layerStyles&&this.layerStyles.length>0)for(const t of this.layerStyles)if(!t||!t.verify())return T(),!1;if(this.effects&&this.effects.length>0)for(const t of this.effects)if(!t||!t.verify())return T(),!1;return!0}getMaxScaleFactor(){if(void 0!==this.maxScale)return this.maxScale;this.maxScale=new _(1,1);const t=this.transform.scale;if(t.animatable()){const{keyframes:e}=t;let i=Math.abs(e[0].startValue.x),r=Math.abs(e[0].startValue.y);if(void 0!==e&&e.length>0)for(const t of e){const e=Math.abs(t.endValue.x),s=Math.abs(t.endValue.y);i<e&&(i=e),r<s&&(r=s)}this.maxScale.x=i,this.maxScale.y=r}else this.maxScale.x=Math.abs(t.value.x),this.maxScale.y=Math.abs(t.value.y);if(void 0!==this.parent){const t=this.parent.getMaxScaleFactor();this.maxScale.x*=t.x,this.maxScale.y*=t.y}return this.maxScale}}const D=.005,M=t=>({red:t.readUint8(),green:t.readUint8(),blue:t.readUint8()}),I=t=>t.readEncodedUint64(),O=t=>{const e=t.readFloat32(),i=t.readFloat32();return new _(e,i)},q=(t,e)=>{e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32(),e.duration=I(t),e.frameRate=t.readFloat32(),e.backgroundColor=M(t)};class G{constructor(){this.tagLevel=0,this.compositions=[],this.errorMessages=[]}throwException(t){this.errorMessages.push(t)}releaseCompositions(){const t=this.compositions.slice();return this.compositions=[],t}}const z="PAG file decode error!";class N{constructor(t,e){this._position=0,this.bitPosition=0,this.dataView=new DataView(t),this.littleEndian=!!e,this.context=new G}get length(){return this.dataView.byteLength}get bytesAvailable(){return this.dataView.byteLength-this._position}data(){return this.dataView.buffer}get position(){return this._position}alignWithBytes(){this.bitPosition=8*this._position}readBoolean(){const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),Boolean(t)}readChar(){if(this._position>=this.length)throw new Error(z);const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),String.fromCharCode(t)}readUint8(){if(this._position>=this.length)throw new Error(z);const t=this.dataView.getUint8(this._position);return this._position+=1,this.positonChanged(),t}readInt8(){if(this._position>=this.length)throw new Error(z);const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),t}readInt16(){if(this._position>=this.length-1)throw new Error(z);const t=this.dataView.getInt16(this._position,this.littleEndian);return this._position+=2,this.positonChanged(),t}readUint16(){if(this._position>=this.length-1)throw new Error(z);const t=this.dataView.getUint16(this._position,this.littleEndian);return this._position+=2,this.positonChanged(),t}readInt24(){if(this._position>=this.length-2)throw new Error(z);const t=this.dataView.getInt16(this._position,this.littleEndian),e=this.dataView.getInt8(this._position+2);return this._position+=3,this.positonChanged(),this.littleEndian?t+65536*e:65536*t+e}readUint24(){if(this._position>=this.length-2)throw new Error(z);const t=this.dataView.getUint16(this._position,this.littleEndian),e=this.dataView.getUint8(this._position+2);return this._position+=3,this.positonChanged(),this.littleEndian?t+65536*e:65536*t+e}readInt32(){if(this._position>=this.length-3)throw new Error(z);const t=this.dataView.getInt32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readUint32(){if(this._position>=this.length-3)throw new Error(z);const t=this.dataView.getUint32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readInt64(){if(this._position>=this.length-7)throw new Error(z);const t=this.dataView.getInt32(this._position,this.littleEndian),e=this.dataView.getInt32(this._position+4,this.littleEndian);return this._position+=8,this.positonChanged(),this.littleEndian?t+2**32*e:2**32*t+e}readUint64(){if(this._position>=this.length-7)throw new Error(z);const t=this.dataView.getUint32(this._position,this.littleEndian),e=this.dataView.getUint32(this._position+4,this.littleEndian);return this._position+=8,this.positonChanged(),this.littleEndian?t+2**32*e:2**32*t+e}readFloat32(){if(this._position>=this.length-3)throw new Error(z);const t=this.dataView.getFloat32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readDouble(){if(this._position>=this.length-7)throw new Error(z);const t=this.dataView.getFloat64(this._position,this.littleEndian);return this._position+=8,this.positonChanged(),t}readUTF8String(){if(this._position>=this.length)throw new Error(z);let t="",e=0;for(let i=this._position;i<this.length&&0!==this.dataView.getUint8(i);i++)t+=`%${this.dataView.getUint8(i).toString(16)}`,e+=1;return this._position+=e,this.positonChanged(),decodeURIComponent(t)}readEncodedUint32(){let t=0,e=0;for(let i=0;i<32;i+=7){if(this._position>=this.length)throw Error("readEncodedUint32 End of file was encountered.");if(e=this.dataView.getUint8(this._position),this._position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChanged(),t}readEncodeInt32(){const t=this.readEncodedUint32(),e=t>>1;return(1&t)>0?-e:e}readEncodedUint64(){let t=0,e=0;for(let i=0;i<64;i+=7){if(this._position>=this.length)throw Error("readEncodedUint64 End of file was encountered.");if(e=this.dataView.getUint8(this._position),this._position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChanged(),t}readEncodeInt64(){const t=this.readEncodedUint64(),e=t<<0;return(1&t)>0?-e:e}readBytes(t){const e=t||this.length-this._position;if(this._position>this.length-e)throw new Error(z);const i=this.dataView.buffer.slice(this._position,this._position+e);return this._position+=e,this.positonChanged(),new N(i,this.littleEndian)}readUBits(t){const e=[0,1,3,7,15,31,63,127,255];let i=0;if(this.bitPosition>8*this.length-t)throw new Error(z);let r=0;for(;r<t;){const s=Math.floor(.125*this.bitPosition),n=this.bitPosition%8;let a=this.dataView.getUint8(s)>>n;const o=Math.min(8-n,t-r);a&=e[o],i|=a<<r,r+=o,this.bitPosition+=o}return this.bitPositionChanged(),i}readBits(t){let e=this.readUBits(t);e<<=32-t;return e<<0>>32-t}readNumBits(){return this.readUBits(5)+1}readInt32List(t){const e=this.readNumBits(),i=new Array(t);for(let r=0;r<t;r++)i[r]=this.readBits(e);return i}readUint32List(t){const e=this.readNumBits(),i=new Array(t);for(let r=0;r<t;r++)i[r]=this.readUBits(e);return i}readBitBoolean(){return 0!==this.readUBits(1)}readFloatList(t,e){const i=this.readNumBits(),r=new Array(t);for(let s=0;s<t;s++)r[s]=this.readBits(i)*e;return r}bitPositionChanged(){this._position=Math.ceil(.125*this.bitPosition)}positonChanged(){this.bitPosition=8*this._position}}class W{constructor(t,e){this.length=0,this.data=t,this.length=e}}class H{constructor(){this.isKeyframe=!1,this.frame=0,this.fileBytes=new W(new N(new ArrayBuffer(0)),0)}}class j{constructor(){this.composition=void 0,this.id=0,this.width=0,this.height=0,this.frameRate=0,this.frameCount=0,this.isKeyFrameFlags=[]}verify(){return R(void 0!==this.composition&&this.width>0&&this.height>0&&this.frameRate>0)}}class X extends j{constructor(){super(...arguments),this.alphaStartX=0,this.alphaStartY=0,this.frames=[],this.headers=[],this.staticTimeRanges=[]}verify(){if(!super.verify()||this.frames.length<=0)return T(),!1;for(const t of this.frames)if(!t||!t.fileBytes)return T(),!1;for(const t of this.headers)if(!t)return T(),!1;return!0}getVideoWidth(){let t=this.alphaStartX+this.width;return t%2==1&&(t+=1),t}getVideoHeight(){let t=this.alphaStartY+this.height;return t%2==1&&(t+=1),t}}const K=t=>{const e=t.readEncodedUint32(),i=t.readBytes(e);if(0===e)throw new Error("Read start code with length 0!");const r=new ArrayBuffer(e+4);return new DataView(r).setUint32(0,e),((t,e,i,r,s)=>{if(e>=t.byteLength||r>=i.byteLength||i.byteLength-r>t.byteLength-e||s>i.byteLength)return;const n=new Uint8Array(t),a=new Uint8Array(i,r,s);n.set(a,e)})(r,4,i.data(),0,e),new W(new N(r),e+4)},Y=(t,e,i)=>{const{composition:r}=i;switch(e){case f.CompositionAttributes:q(t,r);break;case f.VideoSequence:{const e=((t,e)=>{const i=new X;i.width=t.readEncodeInt32(),i.height=t.readEncodeInt32(),i.frameRate=t.readFloat32(),e&&(i.alphaStartX=t.readEncodeInt32(),i.alphaStartY=t.readEncodeInt32());const r=K(t),s=K(t);i.headers.push(r,s),i.frameCount=t.readEncodedUint32();for(let n=0;n<i.frameCount;n++){const e=new H;e.isKeyframe=t.readBitBoolean(),i.frames.push(e)}for(let n=0;n<i.frameCount;n++){const e=i.frames[n];e.frame=I(t),e.fileBytes=K(t)}if(t.bytesAvailable>0){const e=t.readEncodedUint32();for(let r=0;r<e;r++){const e={start:0,end:0};e.start=I(t),e.end=I(t),i.staticTimeRanges.push(e)}}return i})(t,i.hasAlpha);e.composition=r,r.sequences.push(e);break}}};var $=(t=>(t[t.Unknown=0]="Unknown",t[t.Tint=1]="Tint",t[t.Fill=2]="Fill",t[t.Stroke=3]="Stroke",t[t.Tritone=4]="Tritone",t[t.DropShadow=5]="DropShadow",t[t.RadialWipe=6]="RadialWipe",t[t.DisplacementMap=7]="DisplacementMap",t))($||{});function Z(t,e,i){if(i<e)return;for(let r=t.length-1;r>=0;r--){const s=t[r];if(!(s.end<e||s.start>i)){if(s.start<e&&s.end>i){const n={start:i+1,end:s.end};s.end=e-1,n.end>n.start&&t.splice(r+1,0,n),s.end<=s.start&&t.splice(r,1);break}s.start>=e&&s.end<=i?t.splice(r,1):s.start<e?(s.end=e-1,s.end<=s.start&&t.splice(r,1)):(s.start=i+1,s.end<=s.start&&t.splice(r,1))}}}function J(t,e){for(let i=t.length-1;i>=0;i--){const r=t[i];if(r.start===e||r.end<=e)break;if(r.start<e&&r.end>e){const s={start:e,end:r.end};r.end=e-1,s.end>s.start&&t.splice(i+1,0,s),r.end<=r.start&&t.splice(i,1);break}}}class Q extends C{constructor(){super(...arguments),this.layers=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return p.Vector}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}verify(){if(!super.verify())return T(),!1;for(const t of this.layers)if(!t||!t.verify())return T(),!1;return!0}updateStaticTimeRanges(){if(this.duration>1){const t={start:0,end:this.duration-1};this.staticTimeRanges=[t];for(const e of this.layers){if(this.staticTimeRanges.length<=0)break;e.excludeVaryingRanges(this.staticTimeRanges),J(this.staticTimeRanges,e.startTime),J(this.staticTimeRanges,e.startTime+e.duration)}}}}class tt{constructor(t){this.value=t}animatable(){return!1}excludeVaryingRanges(t){}gotoFrame(t){}}class et{static createDefaultTransform2D(){return new et}constructor(){this.anchorPoint=new tt(B),this.position=new tt(B),this.xPosition=new tt(0),this.yPosition=new tt(0),this.scale=new tt(new _(1,1)),this.rotation=new tt(0),this.opacity=new tt(255)}excludeVaryingRanges(t){this.anchorPoint.excludeVaryingRanges(t),void 0!==this.position?this.position.excludeVaryingRanges(t):(this.xPosition.excludeVaryingRanges(t),this.yPosition.excludeVaryingRanges(t)),this.scale.excludeVaryingRanges(t),this.rotation.excludeVaryingRanges(t),this.opacity.excludeVaryingRanges(t)}gotoFrame(t){this.anchorPoint.gotoFrame(t),void 0!==this.position?this.position.gotoFrame(t):(this.xPosition.gotoFrame(t),this.yPosition.gotoFrame(t)),this.scale.gotoFrame(t),this.rotation.gotoFrame(t),this.opacity.gotoFrame(t)}verify(){return void 0!==this.anchorPoint&&(void 0!==this.position||void 0!==this.xPosition&&void 0!==this.yPosition)&&void 0!==this.scale&&void 0!==this.rotation&&void 0!==this.opacity}}class it extends F{constructor(){super(...arguments),this.composition=void 0,this.compositionStartTime=0,this.staticTimeRanges=void 0,this.staticTimeRangeUpdated=!1}static wrap(t){const e=new it;e.duration=t.duration;const i=new et;return e.transform=i,e.composition=t,e}type(){return L.PreCompose}excludeVaryingRanges(t){super.excludeVaryingRanges(t),t&&0!==t.length&&this.updateStaticTimeRanges()}gotoFrame(t){super.gotoFrame(t)}verify(){return!!super.verify()&&!!this.composition}updateStaticTimeRanges(){var t;if(this.staticTimeRangeUpdated)return;this.staticTimeRangeUpdated=!0;const e=null==(t=this.composition)?void 0:t.getStaticTimeRanges();if(e){for(let t=e.length-1;t>=0;t--){const i=e[t];i.start+=this.compositionStartTime,i.end+=this.compositionStartTime,i.end<=this.startTime?e.pop():i.start<this.startTime?i.start=0:i.start>=this.startTime+this.duration-1?e.pop():i.end>this.startTime+this.duration-1&&(i.end=this.startTime+this.duration-1)}this.staticTimeRanges=e}}}class rt extends F{constructor(){super(...arguments),this.contents=[]}type(){return L.Shape}excludeVaryingRanges(t){super.excludeVaryingRanges(t);for(const e of this.contents)e.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t);for(const e of this.contents)e.gotoFrame(t)}verify(){if(!super.verify())return!1;for(const t of this.contents)if(void 0===t||!t.verify())return!1;return!0}}class st extends F{constructor(){super(...arguments),this.solidColor=S,this.width=0,this.height=0}type(){return L.Solid}excludeVaryingRanges(t){super.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t)}verify(){return super.verify()?R(this.width>0&&this.height>0):(T(),!1)}}class nt extends F{type(){return L.undefined}}class at{constructor(){this.startTime=0,this.endTime=0,this.interpolationType=b.Hold,this.bezierOut=[],this.bezierIn=[],this.spatialOut=B,this.spatialIn=B}initialize(){}getValue(t){return this.startValue}containsTime(t){return t>=this.startTime&&t<this.endTime}}class ot extends tt{constructor(t){if(!t||0===t.length)throw new Error("keyframes is required");if(void 0===t[0].startValue)throw new Error("startValue is required");super(t[0].startValue),this.keyframes=t,this.lastKeyframeIndex=0;for(const e of t)e.initialize()}animatable(){return!0}excludeVaryingRanges(t){for(const e of this.keyframes)switch(e.interpolationType){case b.Bezier:case b.Linear:Z(t,e.startTime,e.endTime-1);break;default:J(t,e.startTime),J(t,e.endTime)}}gotoFrame(t){let e=this.keyframes[this.lastKeyframeIndex];if(e.containsTime(t))this.value=e.getValue(t);else{if(t<e.startTime)for(;this.lastKeyframeIndex>0&&(this.lastKeyframeIndex-=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););else for(;this.lastKeyframeIndex<this.keyframes.length-1&&(this.lastKeyframeIndex+=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););e=this.keyframes[this.lastKeyframeIndex],void 0!==e.startValue&&t<=e.startTime?this.value=e.startValue:void 0!==e.endValue&&t>=e.endTime?this.value=e.endValue:this.value=e.getValue(t)}}}var ht=(t=>(t[t.Value=0]="Value",t[t.FixedValue=1]="FixedValue",t[t.SimpleProperty=2]="SimpleProperty",t[t.DiscreteProperty=3]="DiscreteProperty",t[t.MultiDimensionProperty=4]="MultiDimensionProperty",t[t.SpatialProperty=5]="SpatialProperty",t[t.BitFlag=6]="BitFlag",t[t.Custom=7]="Custom",t))(ht||{});const lt=(t,e,i)=>{const r=i,s=[];if(!r.configs||0===r.configs.length)return e;for(const a of r.configs){const e=pt(t,a);s.push(e)}t.alignWithBytes();let n=0;for(const a of r.configs){const i=s[n],r=a.key;a.readAttribute(t,i,e,r),n+=1}return e};class dt{constructor(t,e,i){this.attributeType=e,this.defaultValue=i,this.key=t}readAttribute(t,e,i,r){}readValue(t){}readValueList(t,e,i){}dimensionality(){return 1}newKeyframe(t){return new at}}const ct=(t,e,i,r,s)=>{6===s.attributeType?i[r]=e.exist:1===s.attributeType?i[r]=s.readValue(t):0===s.attributeType?i[r]=mt(t,s,e):i[r]=ut(t,s,e)},ut=(t,e,i)=>{let r;if(i.exist)if(i.animatable){const s=ft(t,e,i);if(!s||0===s.length)throw new Error("Wrong number of keyframes!");gt(t,s,e),yt(t,s,e),i.hasSpatial,r=new ot(s)}else r=new tt(mt(t,e,i));else r=new tt(e.defaultValue);return r},mt=(t,e,i)=>i.exist?e.readValue(t):e.defaultValue,pt=(t,e)=>{const i={exist:!1,animatable:!1,hasSpatial:!1},{attributeType:r}=e;return 1===r?(i.exist=!0,i):(i.exist=t.readBitBoolean(),i.exist&&0!==r&&6!==r&&7!==r?(i.animatable=t.readBitBoolean(),i.animatable&&5===r?(i.hasSpatial=t.readBitBoolean(),i):i):i)},ft=(t,e,i)=>{const r=[],s=t.readEncodedUint32();for(let n=0;n<s;n++){let s;if(3===e.attributeType)s=new at;else{const r=t.readUBits(2);r===b.Hold?s=new at:(s=e.newKeyframe(i),s.interpolationType=r)}r.push(s)}return r},gt=(t,e,i)=>{const r=e.length;e[0].startTime=I(t);for(let a=0;a<r;a++){const i=I(t);e[a].endTime=i,a<r-1&&(e[a+1].startTime=i)}const s=[];i.readValueList(t,s,r+1);let n=0;e[0].startValue=s[n],n+=1;for(let a=0;a<r;a++){const t=s[n];n+=1,e[a].endValue=t,a<r-1&&(e[a+1].startValue=t)}},yt=(t,e,i)=>{const r=4===i.attributeType?i.dimensionality():1,s=t.readNumBits();for(const n of e){if(n.interpolationType!==b.Bezier)continue;let e,i;for(let a=0;a<r;a++)e=t.readBits(s)*D,i=t.readBits(s)*D,n.bezierOut.push({x:e,y:i}),e=t.readBits(s)*D,i=t.readBits(s)*D,n.bezierIn.push({x:e,y:i})}};function wt(t,e,i){return t+(e-t)*i}class vt{getInterpolation(t){return t}}class bt extends at{initialize(){super.initialize(),this.interpolationType===b.Bezier||(this.xInterpolator=new vt,this.yInterpolator=new vt)}getValue(t){var e,i,r,s;const n=(t-this.startTime)/(this.endTime-this.startTime),a=null!=(i=null==(e=this.xInterpolator)?void 0:e.getInterpolation(n))?i:n,o=null!=(s=null==(r=this.yInterpolator)?void 0:r.getInterpolation(n))?s:n;return{x:wt(this.startValue.x,this.endValue.x,a),y:wt(this.startValue.y,this.endValue.y,o)}}}class xt extends at{initialize(){this.interpolationType===b.Bezier||(this.interpolator=new vt)}getProgress(t){var e,i;const r=(t-this.startTime)/(this.endTime-this.startTime);return null!=(i=null==(e=this.interpolator)?void 0:e.getInterpolation(r))?i:r}getValue(t){const e=this.getProgress(t);return wt(this.startValue,this.endValue,e)}}class St extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return t.readFloat32()}readValueList(t,e,i){for(let r=0;r<i;r++)e.push(this.readValue(t))}dimensionality(){return 1}newKeyframe(t){return new xt}}class Et extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return t.readBoolean()}readValueList(t,e,i){for(let r=0;r<i;r++)e.push(t.readBitBoolean())}dimensionality(){return 1}newKeyframe(t){return new at}}class Tt extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return t.readUint8()}readValueList(t,e,i){const r=t.readUint32List(i);for(let s=0;s<i;s++)e.push(r[s])}dimensionality(){return 1}newKeyframe(t){return new xt}}class Rt extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return I(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new xt}}class Pt extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return O(t)}readValueList(t,e,i){if(this.attributeType===ht.SpatialProperty){const r=t.readFloatList(2*i,.05);for(let t=0;t<i;t++)e[t]||(e[t]=new _(0,0)),e[t].x=r[t]}else for(let r=0;r<i;r++)e[r]=O(t)}dimensionality(){return 2}newKeyframe(t){return this.attributeType===ht.MultiDimensionProperty?new bt:new xt}}class Ct extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return(t=>{const e=t.readEncodeInt32(),i=t.readEncodedUint32();return new V(e,i)})(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new xt}}class At extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return(t=>{const e=t.readEncodedUint32();if(0===e)throw new Error("Layer ID is 0");const i=new F;return i.id=e,i})(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new xt}}const Vt={tagCode:f.LayerAttributes,configs:[new Et("isActive",ht.BitFlag,!0),new Et("autoOrientation",ht.BitFlag,!1),new At("parent",ht.Value,void 0),new Ct("stretch",ht.Value,k),new Rt("startTime",ht.Value,0),new Tt("blendMode",ht.Value,v.Normal),new Tt("trackMatteType",ht.Value,U.None),new St("timeRemap",ht.SimpleProperty,0),new Rt("duration",ht.FixedValue,0)]},kt={tagCode:f.LayerAttributesV2,configs:[new Et("isActive",ht.BitFlag,!0),new Et("autoOrientation",ht.BitFlag,!1),new At("parent",ht.Value,void 0),new Ct("stretch",ht.Value,k),new Rt("startTime",ht.Value,0),new Tt("blendMode",ht.Value,v.Normal),new Tt("trackMatteType",ht.Value,U.None),new St("timeRemap",ht.SimpleProperty,0),new Rt("duration",ht.FixedValue,0),new class extends dt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){ct(t,e,i,r,this)}readValue(t){return t.readUTF8String()}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new xt}}("name",ht.Value,"")]},_t={tagCode:f.Transform2D,configs:[new Pt("anchorPoint",ht.SpatialProperty,B),new Pt("position",ht.SpatialProperty,B),new St("xPosition",ht.SimpleProperty,0),new St("yPosition",ht.SimpleProperty,0),new Pt("scale",ht.MultiDimensionProperty,new _(1,1)),new St("rotation",ht.SimpleProperty,0),new Tt("opacity",ht.SimpleProperty,255)]};f.MaskBlock;const Bt=(t,e,i)=>{switch(e){case f.LayerAttributes:lt(t,i,Vt),i.duration<=0&&(i.duration=1);break;case f.LayerAttributesV2:lt(t,i,kt),i.duration<=0&&(i.duration=1);break;case f.Transform2D:i.transform=new et,lt(t,i.transform,_t),i.transform.position.animatable()||i.transform.position.value!==B||!i.transform.xPosition.animatable()&&0===i.transform.xPosition.value&&!i.transform.yPosition.animatable()&&0===i.transform.yPosition.value?(i.transform.xPosition=new tt(0),i.transform.yPosition=new tt(0)):i.transform.position=new tt(B);break;case f.SolidColor:i.type()===L.Solid&&function(t,e){e.solidColor=M(t),e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32()}(t,i);break;case f.CompositionReference:i.type()===L.PreCompose&&function(t,e){const i=t.readEncodedUint32();i>0&&(e.composition=new C,e.composition.id=i),e.compositionStartTime=I(t)}(t,i)}},Ut=(t,e,i)=>{switch(e){case f.CompositionAttributes:q(t,i);break;case f.LayerBlock:i.layers.push((t=>{let e;switch(t.readUint8()){case L.undefined:e=new nt;break;case L.Solid:e=new st;break;case L.Shape:e=new rt;break;case L.PreCompose:e=new it;break;default:e=new F}return e.id=t.readEncodedUint32(),y(t,e,Bt),e})(t))}},Lt=t=>{if(t&&0===t.length)return;const e=new Map;for(const r of t)r&&(Ft(r),e.set(r.id,r));let i=0;for(const r of t)if(r){if(void 0!==r.parent){const t=r.parent.id,i=e.get(t);void 0!==i&&(r.parent=i)}if(i>0&&Dt(r.trackMatteType)&&(r.trackMatteLayer=t[i-1]),void 0!==r.effects&&r.effects.length>0)for(const t of r.effects)t&&(t.type(),$.DisplacementMap);i+=1}},Ft=t=>{var e;if(!t||!t.masks||0===t.masks.length)return;const i=new Map;for(const r of t.masks)r&&i.set(r.id,r);if(null==(e=t.effects)||e.forEach((t=>{if(t){if(void 0!==t.maskReferences&&t.maskReferences.length>0){const e=new Array;t.maskReferences.forEach((t=>{const r=t.id,s=i.get(r);void 0!==s&&e.push(s)})),t.maskReferences=e}switch(t.type()){case $.Fill:if(void 0!==t.fillMask){const e=t.fillMask.id,r=i.get(e);void 0!==r&&(t.fillMask=r)}break;case $.Stroke:{const e=t;if(void 0!==e.path){const t=e.path.id,r=i.get(t);void 0!==r&&(e.path=r)}break}}}})),t.type()===L.Text){const{pathOption:e}=t;if(null==e?void 0:e.path){const t=e.path.id,r=i.get(t);void 0!==r&&(e.path=r)}}},Dt=t=>{switch(t){case U.Alpha:case U.AlphaInverted:return!0;default:return!1}};function Mt(t,e,i){switch(e){case f.VectorCompositionBlock:i.compositions.push((t=>{const e=new Q;return e.id=t.readEncodedUint32(),y(t,e,Ut),Lt(e.layers),e})(t));break;case f.VideoCompositionBlock:i.compositions.push((t=>{const e=new A;return e.id=t.readEncodedUint32(),e.hasAlpha=t.readBoolean(),y(t,{composition:e,hasAlpha:e.hasAlpha},Y),e})(t))}}const It=t=>{const e=Ot(t),{context:i}=e;y(e,i,Mt),function(t){if(!t||0===t.length)return;const e=new Map;t.forEach((t=>{t&&e.set(t.id,t)})),t.forEach((t=>{if(t&&t.type()===p.Vector){const i=t;i.layers&&i.layers.length>0&&i.layers.forEach((t=>{t.containingComposition=i;const r=t;if(r.type()===L.PreCompose&&r.composition){const t=e.get(r.composition.id);t&&(r.composition=t)}}))}}))}(i.compositions);const r=i.releaseCompositions();return(t=>{let e=t.length>0;for(const i of t)if(!i||!i.verify()){e=!1;break}if(!e)throw new Error("Verify composition failed!")})(r),{compositions:r,tagLevel:i.tagLevel}},Ot=t=>{if(t.length<11)throw new Error("PAG file is invalid!");const e=t.readInt8(),i=t.readInt8(),r=t.readInt8();if(80!==e||65!==i||71!==r)throw new Error("invalid PAG header!");return t.readInt8(),t.readUint32(),t.readInt8(),t.readBytes()};class qt{constructor(t,e){this.tagLevel=1,this.compositions=[],this.numLayers=0,this.scaledTimeRange={start:0,end:0},this.mainComposition=t[t.length-1],this.scaledTimeRange.start=0,this.scaledTimeRange.end=this.mainComposition.duration,this.compositions=t,this.duration=this.mainComposition.duration,this.implDuration=1e3*this.mainComposition.duration/this.mainComposition.frameRate;for(const i of t)if(i.type()===p.Vector)for(const t of i.layers)t.type()!==L.PreCompose&&(this.numLayers+=1);else this.numLayers+=1;this.tagLevel=e}static fromArrayBuffer(t){if(!t||0===t.byteLength)throw new Error("Can't read empty array buffer!");const e=new N(t,!0),{compositions:i,tagLevel:r}=It(e);return new qt(i,r)}getVideoSequence(){const t=this.mainComposition.type();return t===p.Video?Gt(this.mainComposition):t===p.Vector?zt(this.mainComposition):void 0}}const Gt=t=>{if(!t.sequences||0===t.sequences.length)throw new Error("PAGFile has no BMP video sequence!");return t.sequences[t.sequences.length-1]},zt=t=>{const e=Nt(t);if(e.length>1)throw new Error("PAGFile has more than one BMP video sequence!");if(e.length<1)throw new Error("PAGFile has no BMP video sequence!");const i=e[0];return Gt(i)},Nt=t=>{const e=[];return t.layers.forEach((t=>{if(t.type()!==L.PreCompose)return;const{composition:i}=t;(null==i?void 0:i.type())!==p.Video?(null==i?void 0:i.type())===p.Vector&&e.push(...Nt(i)):e.push(i)})),e};var Wt=(t=>(t.Canvas2D="2d",t.WebGL="WebGL",t))(Wt||{}),Ht=(t=>(t.onAnimationStart="onAnimationStart",t.onAnimationEnd="onAnimationEnd",t.onAnimationCancel="onAnimationCancel",t.onAnimationRepeat="onAnimationRepeat",t.onAnimationUpdate="onAnimationUpdate",t.onAnimationPlay="onAnimationPlay",t.onAnimationPause="onAnimationPause",t))(Ht||{}),jt=(t=>(t.None="None",t.Stretch="Stretch",t.LetterBox="LetterBox",t.Zoom="Zoom",t))(jt||{});function Xt(t){let e=Object.getOwnPropertyNames(t.prototype).filter((e=>"constructor"!==e&&"function"==typeof t.prototype[e]));const i=(t,e)=>{const i=t[e];t[e]=function(...t){if(!this.destroyed)return i.call(this,...t);console.error(`Don't call ${e} of the PAGView that is destroyed.`)}};e.forEach((e=>i(t.prototype,e)))}const Kt=(t,e,i)=>{const r=t.createProgram();if(!r)throw new Error("Failed to create program.");const s=Yt(t,e,t.VERTEX_SHADER);if(!s)throw new Error("Failed to create vertex shader.");t.attachShader(r,s);const n=Yt(t,i,t.FRAGMENT_SHADER);if(!n)throw new Error("Failed to create fragment shader.");t.attachShader(r,n),t.linkProgram(r);const a=t.getProgramInfoLog(r);a&&console.log(a);const o=t.getShaderInfoLog(s);o&&console.log(o);const h=t.getShaderInfoLog(n);return h&&console.log(h),r},Yt=(t,e,i)=>{const r=t.createShader(i);if(!r)throw new Error("Failed to create shader.");return t.shaderSource(r,e),t.compileShader(r),r},$t=t=>t.replace(/^\s+|\s+$/g,""),Zt=t=>{const e=t.createTexture();if(!e)throw new Error("Failed to create texture.");return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),e};class Jt{constructor(){this.listenersMap={}}on(t,e){void 0===this.listenersMap[t]&&(this.listenersMap[t]=[]),this.listenersMap[t].push(e)}off(t,e){const i=this.listenersMap[t];if(void 0===i)return;if(void 0===e)return void delete this.listenersMap[t];const r=i.findIndex((t=>t===e));i.splice(r,1)}emit(t,...e){const i=this.listenersMap[t];if(void 0===i||i.length<1)return!1;for(const r of i)r(...e);return!0}}var Qt=Object.defineProperty,te=Object.getOwnPropertyDescriptor,ee=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,se=(t,e,i)=>e in t?Qt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ne=(t,e)=>{for(var i in e||(e={}))ie.call(e,i)&&se(t,i,e[i]);if(ee)for(var i of ee(e))re.call(e,i)&&se(t,i,e[i]);return t};let ae=class{constructor(t,e,i){this.canvasSize={width:0,height:0},this.playing=!1,this.viewportSize={x:0,y:0,width:0,height:0,scaleX:1,scaleY:1},this.destroyed=!1,this.renderTimer=null,this.repeatCount=0,this.viewScaleMode=jt.LetterBox,this.debugData={FPS:0,decodePAGFile:0,createDir:0,coverMP4:0,writeFile:0,createDecoder:0,getFrame:0,draw:0};const r=t.getVideoSequence();if(!r)throw new Error("PAGFile has no BMP video sequence!");delete r.composition,this.videoSequence=r,this.canvas=e,this.videoParam=((t,e)=>({width:t.mainComposition.width,height:t.mainComposition.height,hasAlpha:e.alphaStartX>0||e.alphaStartY>0,alphaStartX:e.alphaStartX,alphaStartY:e.alphaStartY,sequenceWidth:e.width,sequenceHeight:e.height,MP4Width:(e.width+e.alphaStartX)%2==0?e.width+e.alphaStartX:e.width+e.alphaStartX+1,MP4Height:(e.height+e.alphaStartY)%2==0?e.height+e.alphaStartY:e.height+e.alphaStartY+1}))(t,r),this.eventManager=new Jt,this.renderingMode=i.renderingMode||Wt.WebGL,this.updateSize(i.useScale),this.setScaleMode()}isPlaying(){return this.playing}isDestroyed(){return this.destroyed}duration(){return this.videoSequence.frameCount/this.videoSequence.frameRate}frameRate(){return this.videoSequence.frameRate}setRepeatCount(t=1){this.repeatCount=t<0?-1:t-1}addListener(t,e){return this.eventManager.on(t,e)}removeListener(t,e){return this.eventManager.off(t,e)}scaleMode(){return this.viewScaleMode}setScaleMode(t=jt.LetterBox){switch(this.viewScaleMode=t,t){case jt.None:this.viewportSize={x:0,y:this.renderingMode===Wt.WebGL?this.canvas.height-this.videoParam.height:0,width:this.videoParam.width,height:this.videoParam.height,scaleX:1,scaleY:1};break;case jt.Stretch:this.viewportSize={x:0,y:0,width:this.canvas.width,height:this.canvas.height,scaleX:this.canvas.width/this.videoParam.sequenceWidth,scaleY:this.canvas.height/this.videoParam.sequenceHeight};break;case jt.LetterBox:{const t=this.canvas.width/this.videoParam.sequenceWidth,e=this.canvas.height/this.videoParam.sequenceHeight,i=Math.min(t,e);this.viewportSize={x:(this.canvas.width-this.videoParam.sequenceWidth*i)/2,y:(this.canvas.height-this.videoParam.sequenceHeight*i)/2,width:this.videoParam.sequenceWidth*i,height:this.videoParam.sequenceHeight*i,scaleX:i,scaleY:i}}break;case jt.Zoom:{const t=this.canvas.width/this.videoParam.sequenceWidth,e=this.canvas.height/this.videoParam.sequenceHeight,i=Math.max(t,e);this.viewportSize={x:(this.canvas.width-this.videoParam.sequenceWidth*i)/2,y:(this.canvas.height-this.videoParam.sequenceHeight*i)/2,width:this.videoParam.sequenceWidth*i,height:this.videoParam.sequenceHeight*i,scaleX:i,scaleY:i}}}}updateSize(t=!0){if(!this.canvas)throw new Error("Canvas element is not found!");let e;const i=getComputedStyle(this.canvas),r={width:Number(i.width.replace("px","")),height:Number(i.height.replace("px",""))};if(r.width>0&&r.height>0)e=r;else{const t={width:Number(this.canvas.style.width.replace("px","")),height:Number(this.canvas.style.height.replace("px",""))};e=t.width>0&&t.height>0?t:{width:this.canvas.width,height:this.canvas.height}}if(!t)return this.canvas.width=this.canvas.width||e.width,void(this.canvas.height=this.canvas.height||e.height);this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`,this.canvas.width=e.width*window.devicePixelRatio,this.canvas.height=e.height*window.devicePixelRatio}getDebugData(){return this.debugData}setDebugData(t){this.debugData=ne(ne({},this.debugData),t)}loadContext(){}clearRender(){}};ae=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?te(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Qt(e,i,n),n})([Xt],ae);const oe=2082873600,he=t=>{const e=[];for(let i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},le=t=>[t>>24,t>>16&255,t>>8&255,255&t],de=(t,...e)=>{let i=8,r=e.length;const s=r;for(;r;)r-=1,i+=e[r].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=255&i,n.set(t,4),r=0,i=8;r<s;++r)n.set(e[r],i),i+=e[r].byteLength;return n};class ce{constructor(t){this.param=t}ftyp(){return de(he("ftyp"),new Uint8Array(he("isom")),new Uint8Array([0,0,0,1]),new Uint8Array(he("isom")),new Uint8Array(he("iso2")),new Uint8Array(he("avc1")),new Uint8Array(he("mp41")))}moov(){const t=this.param.tracks.map((t=>this.trak(t))).reverse();return de(he("moov"),this.mvhd(),...t,this.mvex())}moof(){return de(he("moof"),this.mfhd(),this.traf())}mdat(){const t=new Uint8Array(this.param.track.len);let e=0;return this.param.videoSequence.headers.forEach((i=>{t.set(new Uint8Array(i.data.data()),e),e+=i.length})),this.param.videoSequence.frames.forEach(((i,r)=>{t.set(new Uint8Array(i.fileBytes.data.data()),e),e+=i.fileBytes.length})),de(he("mdat"),t)}mvhd(){return de(he("mvhd"),new Uint8Array([0,0,0,0,...le(oe),...le(oe),...le(this.param.timescale),...le(this.param.duration),0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]))}trak(t){return de(he("trak"),this.tkhd(t),this.edts(t),this.mdia(t))}tkhd(t){return de(he("tkhd"),new Uint8Array([0,0,0,1,...le(oe),...le(oe),...le(t.id),0,0,0,0,...le(t.duration),0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,t.width>>8&255,255&t.width,0,0,t.height>>8&255,255&t.height,0,0]))}edts(t){return de(he("edts"),this.elst(t))}elst(t){return de(he("elst"),new Uint8Array([0,0,0,0,...le(1),...le(t.duration),...le(t.implicitOffset*Math.floor(t.duration/t.samples.length)),0,1,0,0]))}mdia(t){return de(he("mdia"),this.mdhd(),this.hdlr(),this.minf(t))}mdhd(){return de(he("mdhd"),new Uint8Array([0,0,0,0,...le(oe),...le(oe),...le(this.param.timescale),...le(0),85,196,0,0]))}hdlr(){return de(he("hdlr"),new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]))}minf(t){return de(he("minf"),this.vmhd(),this.dinf(),this.stbl(t))}vmhd(){return de(he("vmhd"),new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}dinf(){return de(he("dinf"),this.dref())}dref(){return de(he("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]))}stbl(t){return de(he("stbl"),this.stsd(t),this.stts(t),this.ctts(t),this.stss(t),this.stsc(),this.stsz(),this.stco())}stsd(t){return de(he("stsd"),new Uint8Array([0,0,0,0,0,0,0,1]),this.avc1(t))}avc1(t){const e=[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255];return de(he("avc1"),new Uint8Array(e),this.avcc(t))}avcc(t){let e=[],i=[];t.sps.forEach((t=>{const i=t.length-4;e.push(i>>>8&255),e.push(255&i),e=e.concat(Array.prototype.slice.call(new Uint8Array(t.data.data(),4)))})),t.pps.forEach((t=>{const e=t.length-4;i.push(e>>>8&255),i.push(255&e),i=i.concat(Array.prototype.slice.call(new Uint8Array(t.data.data(),4)))}));const r=[1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(i);return de(he("avcC"),new Uint8Array(r))}stts(t){return de(he("stts"),new Uint8Array([0,0,0,0,...le(1),...le(t.samples.length),...le(Math.floor(t.duration/t.samples.length))]))}ctts(t){const e=t.pts.length,i=Math.floor(t.duration/e),r=[0,0,0,0,...le(e)];for(let s=0;s<e;s++){r.push(...le(1));const e=s*i,n=(t.pts[s]+t.implicitOffset)*i;r.push(...le(n-e))}return de(he("ctts"),new Uint8Array(r))}stss(t){const e=t.samples.filter((t=>t.flags.isKeyFrame)).map((t=>t.index+1)),i=[0,0,0,0,...le(e.length)];return e.forEach((t=>{i.push(...le(t))})),de(he("stss"),new Uint8Array(i))}stsc(){return de(he("stsc"),new Uint8Array([0,0,0,0,0,0,0,0]))}stsz(){return de(he("stsz"),new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]))}stco(){return de(he("stco"),new Uint8Array([0,0,0,0,0,0,0,0]))}mvex(){const t=this.param.tracks.map((t=>this.trex(t))).reverse();return de(he("mvex"),...t)}trex(t){return de(he("trex"),new Uint8Array([0,0,0,0,t.id>>24,t.id>>16&255,t.id>>8&255,255&t.id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}mfhd(){return de(he("mfhd"),new Uint8Array([0,0,0,0,this.param.sequenceNumber>>24,this.param.sequenceNumber>>16&255,this.param.sequenceNumber>>8&255,255&this.param.sequenceNumber]))}traf(){const t=this.sdtp();return this.param.offset=t.length+72,de(he("traf"),this.tfhd(),this.tfdt(),this.trun(),t)}tfhd(){return de(he("tfhd"),new Uint8Array([0,0,0,0,...le(this.param.track.id)]))}tfdt(){return de(he("tfdt"),new Uint8Array([0,0,0,0,...le(this.param.baseMediaDecodeTime)]))}trun(){const t=(this.param.track.samples||[]).length,e=12+16*t;this.param.offset+=8+e;const i=[0,0,15,1,...le(t),...le(this.param.offset)];return this.param.track.samples.forEach((t=>{const{duration:e,size:r,flags:s,cts:n}=t;i.push(...le(e)),i.push(...le(r)),i.push(s.isLeading<<2|s.dependsOn),i.push(s.isDependedOn<<6|s.hasRedundancy<<4|0|s.isNonSync),i.push(61440&s.degradPrio),i.push(15&s.degradPrio),i.push(...le(n))})),de(he("trun"),new Uint8Array(i))}sdtp(){const t=new Uint8Array(4+this.param.track.samples.length);return this.param.track.samples.forEach(((e,i)=>{t[i+4]=e.flags.dependsOn<<4|e.flags.isDependedOn<<2|e.flags.hasRedundancy})),de(he("sdtp"),t)}}var ue=Object.defineProperty,me=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,fe=Object.prototype.propertyIsEnumerable,ge=(t,e,i)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ye=(t,e)=>{for(var i in e||(e={}))pe.call(e,i)&&ge(t,i,e[i]);if(me)for(var i of me(e))fe.call(e,i)&&ge(t,i,e[i]);return t};const we=t=>{const e=x?xe(t):t,i=ve(e);if(!i||0===i.len)throw new Error("mp4Track is empty");const r={offset:0,tracks:[i],track:i,duration:i.duration,timescale:i.timescale,sequenceNumber:1,baseMediaDecodeTime:0,nalusBytesLen:i.len,videoSequence:e},s=new ce(r);return(t=>{let e=0;for(const s of t)e+=s.byteLength;const i=new Uint8Array(e);let r=0;for(const s of t)i.set(s,r),r+=s.byteLength;return i})([s.ftyp(),s.moov(),s.moof(),s.mdat()])},ve=t=>{if(t.headers.length<2)throw new Error("Bad header data in video sequence!");if(0===t.frames.length)throw new Error("There is no frame data in the video sequence!");const e={id:1,type:"video",timescale:6e3,duration:Math.floor(6e3*t.frames.length/t.frameRate),width:t.getVideoWidth(),height:t.getVideoHeight(),sps:[t.headers[0]],pps:[t.headers[1]],implicitOffset:be(t.frames),len:0,pts:[],samples:[]},i=t.headers.reduce(((t,e)=>t+e.length),0),r=e.duration/t.frames.length;return t.frames.forEach(((t,s)=>{var n;let a=null!=(n=t.fileBytes.length)?n:0;0===s&&(a+=i),e.len+=a,e.pts.push(t.frame),e.samples.push({index:s,size:a,duration:r,cts:(t.frame+e.implicitOffset-s)*r,flags:{isKeyFrame:t.isKeyframe,isNonSync:t.isKeyframe?0:1,dependsOn:t.isKeyframe?2:1,isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}})})),e},be=t=>Math.max(...t.map(((t,e)=>e-t.frame))),xe=t=>{const e=t.frames.length;for(let i=0;i<t.frames.length;i++){const r=ye({},t.frames[i]);if(r.isKeyframe&&i>0)break;r.frame+=e,t.frames.push(r)}return t};let Se={};const Ee=(t,e,i,r=!1)=>{var s;e in Se||(Se[e]=[]),null==(s=Se[e])||s.push({node:t,handler:i,capture:r}),t.addEventListener(e,i,r)};var Te=Object.defineProperty,Re=Object.getOwnPropertyDescriptor;const Pe=navigator&&/MicroMessenger/i.test(navigator.userAgent),Ce=async t=>{Pe&&window.WeixinJSBridge&&await new Promise((t=>{window.WeixinJSBridge.invoke("getNetworkType",{},(()=>{t()}),(()=>{t()}))}));try{await t.play()}catch(e){throw new Error(e.message)}};let Ae=class{constructor(t){this.destroyed=!1,this.frameRate=0,this._duration=t.frameCount/t.frameRate,this.frameRate=t.frameRate}static create(t){const e=new Ae(t),i=e.load(t);return{videoReader:e,debugData:i}}getVideoElement(){return this.videoElement}progress(){return Math.round(this.videoElement.currentTime/this._duration*100)/100}duration(){return this._duration}currentTime(){return this.videoElement.currentTime||0}start(){return Ce(this.videoElement)}pause(){var t;null==(t=this.videoElement)||t.pause()}seek(t){return new Promise((e=>{const i=()=>{var t,r,s,n,a,o,h;t=this.videoElement,s=i,(r="seeked")in Se&&(s?(null==(n=Se[r])||n.filter((({node:e,handler:i})=>e===t&&i===s)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(r,e,i))),Se[r]=null==(a=Se[r])?void 0:a.filter((({node:e,handler:i})=>!(e===t&&i===s)))):(null==(o=Se[r])||o.filter((({node:e})=>e===t)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(r,e,i))),Se[r]=null==(h=Se[r])?void 0:h.filter((({node:e})=>e!==t)))),e()};Ee(this.videoElement,"seeked",i),this.videoElement.currentTime=t}))}addListener(t,e){Ee(this.videoElement,t,e)}removeAllListeners(){var t;t=this.videoElement,Object.keys(Se).forEach((e=>{var i,r;const s=e;null==(i=Se[s])||i.filter((({node:e})=>e===t)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(s,e,i))),Se[s]=null==(r=Se[s])?void 0:r.filter((({node:e})=>e!==t))}))}getFrameData(t){}clearCallback(){}destroy(){this.removeAllListeners(),this.videoElement=void 0,this.destroyed=!0}load(t){this.videoElement=document.createElement("video"),this.videoElement.style.display="none",this.videoElement.muted=!0,this.videoElement.playsInline=!0;const e=new m,i=we(t);return e.mark("coverMP4"),this.videoElement.src=URL.createObjectURL(new Blob([i],{type:"video/mp4"})),this.videoElement.load(),{coverMP4:e.measure("","coverMP4")}}};Ae=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Re(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Te(e,i,n),n})([Xt],Ae);var Ve=Object.defineProperty,ke=Object.getOwnPropertyDescriptor;let _e=class extends ae{constructor(t,e,i){super(t,e,i),this.fpsBuffer=[],this.currentFrame=-1,this.needSeek=!1,this.videoReader=this.createVideoReader(this.videoSequence)}async play(){this.playing||(this.playing=!0,await this.videoReader.start(),await this.flushLoop(),0===this.getProgress()&&this.eventManager.emit(Ht.onAnimationStart),this.eventManager.emit(Ht.onAnimationPlay))}pause(){this.playing&&(this.videoReader.pause(),this.clearTimer(),this.playing=!1,this.eventManager.emit(Ht.onAnimationPause))}stop(){this.videoReader.pause(),this.videoReader.seek(0),this.clearRender(),this.playing=!1,this.eventManager.emit(Ht.onAnimationCancel)}destroy(){this.clearTimer(),this.clearRender(),this.canvas=null,this.videoReader.destroy(),this.destroyed=!0}getProgress(){return this.currentFrame/this.videoSequence.frameCount}setProgress(t){if(t<0||t>1)throw new Error("progress must be between 0.0 and 1.0!");const e=Math.round(t*this.videoSequence.frameCount);this.currentFrame!==e&&(this.needSeek=!0,this.currentFrame=e)}flush(){return this.flushInternal(!0)}draw(){}createVideoReader(t){const{videoReader:e,debugData:i}=Ae.create(t);return this.setDebugData(i),x||e.addListener("ended",(()=>{this.repeat()})),e}async repeat(){return 0===this.repeatCount?(this.setProgress(1),await this.flushInternal(!0),this.videoReader.pause(),this.clearTimer(),this.playing=!1,this.eventManager.emit("onAnimationEnd"),!1):(this.repeatCount-=1,x?await this.videoReader.seek(0):this.videoReader.start(),this.eventManager.emit("onAnimationRepeat"),!0)}flushLoop(){return this.renderTimer=window.requestAnimationFrame((()=>{this.flushLoop()})),x&&this.duration()-this.videoReader.currentTime()<=1/this.frameRate()&&this.repeat(),this.flushInternal(!1)}clearTimer(){this.renderTimer&&(window.cancelAnimationFrame(this.renderTimer),this.renderTimer=null)}updateFPS(){let t;try{t=performance.now()}catch(Ze){t=Date.now()}this.fpsBuffer=this.fpsBuffer.filter((e=>t-e<=1e3)),this.fpsBuffer.push(t),this.setDebugData({FPS:this.fpsBuffer.length})}async flushInternal(t){const e=new m;this.needSeek?(t?await this.videoReader.seek(this.currentFrame/this.frameRate()):this.videoReader.seek(this.currentFrame/this.frameRate()),this.needSeek=!1):this.currentFrame=Math.floor(this.videoReader.currentTime()*this.frameRate()),this.draw(),e.mark("draw"),this.setDebugData({draw:e.measure("","draw")}),this.updateFPS(),this.eventManager.emit(Ht.onAnimationUpdate)}};_e=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?ke(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Ve(e,i,n),n})([Xt],_e);var Be=Object.defineProperty,Ue=Object.getOwnPropertyDescriptor;let Le=class extends _e{constructor(t,e,i){var r;super(t,e,i);const s=null==(r=this.canvas)?void 0:r.getContext("2d");if(!s)throw new Error("Can't get 2d context!");this.context=s,this.renderCanvas2D=document.createElement("canvas"),this.renderCanvas2D.width=this.videoParam.MP4Width,this.renderCanvas2D.height=this.videoParam.MP4Height;const n=this.renderCanvas2D.getContext("2d");if(!n)throw new Error("Can't get 2d context!");this.renderCanvas2DContext=n}draw(){if(this.videoParam.hasAlpha){this.renderCanvas2DContext.clearRect(0,0,this.renderCanvas2D.width,this.renderCanvas2D.height),this.renderCanvas2DContext.drawImage(this.videoReader.getVideoElement(),0,0,this.renderCanvas2D.width,this.renderCanvas2D.height);const t=this.renderCanvas2DContext.getImageData(0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),e=this.renderCanvas2DContext.getImageData(this.videoParam.alphaStartX,this.videoParam.alphaStartY,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),i=t.data.length/4;for(let r=0;r<i;r++)t.data[4*r+3]=e.data[4*r+0];this.renderCanvas2DContext.clearRect(0,0,this.renderCanvas2D.width,this.renderCanvas2D.height),this.renderCanvas2DContext.putImageData(t,0,0,0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.renderCanvas2D,0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight,this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height)}else this.context.drawImage(this.videoReader.getVideoElement(),0,0,this.videoParam.MP4Width,this.videoParam.MP4Height,this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height)}clearRender(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};Le=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Ue(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Be(e,i,n),n})([Xt],Le);const Fe="\n      attribute vec2 a_position;\n      attribute vec2 a_texCoord;\n      \n      uniform vec2 u_resolution;\n      uniform vec2 u_scale;\n      \n      varying vec2 v_texCoord;\n    \n      \n      void main() {\n         // convert the rectangle from pixels to 0.0 to 1.0\n         vec2 zeroToOne = a_position / u_resolution;\n      \n         // convert from 0->1 to 0->2\n         vec2 zeroToTwo = zeroToOne * 2.0;\n      \n         // convert from 0->2 to -1->+1 (clipspace)\n         vec2 clipSpace = zeroToTwo - 1.0;\n      \n         gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n      \n         // pass the texCoord to the fragment shader\n         // The GPU will interpolate this value between points.\n         v_texCoord = a_texCoord / u_scale;\n      }\n        ";var De=Object.defineProperty,Me=Object.getOwnPropertyDescriptor,Ie=Object.getOwnPropertySymbols,Oe=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable,Ge=(t,e,i)=>e in t?De(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;let ze=class extends _e{constructor(t,e,i){var r;super(t,e,i),this.scale={x:1,y:1},this.positionLocation=0,this.texcoordLocation=0,this.alphaStartLocation=null,this.scaleLocation=null,this.resolutionLocation=null,this.positionBuffer=null,this.texcoordBuffer=null,this.originalVideoTexture=null,this.renderingTexture=null,this.renderingFbo=null;const s=null==(r=this.canvas)?void 0:r.getContext("webgl",((t,e)=>{for(var i in e||(e={}))Oe.call(e,i)&&Ge(t,i,e[i]);if(Ie)for(var i of Ie(e))qe.call(e,i)&&Ge(t,i,e[i]);return t})({},w));if(!s)throw new Error("Can't get WebGL context!");this.gl=s,this.videoParam.hasAlpha?this.program=Kt(this.gl,$t(Fe),$t("\n      precision mediump float;\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      uniform vec2 v_alphaStart;\n      \n      void main() {\n         vec4 color = texture2D(u_image, v_texCoord);\n         vec4 alpha = texture2D(u_image, vec2(v_texCoord.x + v_alphaStart.x, v_texCoord.y + v_alphaStart.y));\n         gl_FragColor = vec4(color.rgb * alpha.r, alpha.r);\n      }     \n         ")):this.program=Kt(this.gl,$t(Fe),$t("\n      precision mediump float;\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      \n      void main() {\n         gl_FragColor = texture2D(u_image, v_texCoord);\n      }\n         ")),this.loadContext()}loadContext(){if(!this.program)throw new Error("program is not initialized");if(this.positionLocation=this.gl.getAttribLocation(this.program,"a_position"),-1===this.positionLocation)throw new Error("unable to get attribute location for a_position");if(this.scaleLocation=this.gl.getUniformLocation(this.program,"u_scale"),-1===this.scaleLocation)throw new Error("unable to get attribute location for u_scale");if(this.texcoordLocation=this.gl.getAttribLocation(this.program,"a_texCoord"),-1===this.texcoordLocation)throw new Error("unable to get attribute location for a_texCoord");if(this.videoParam.hasAlpha&&(this.alphaStartLocation=this.gl.getUniformLocation(this.program,"v_alphaStart"),!this.alphaStartLocation))throw new Error("unable to get attribute location for v_alphaStart");if(this.resolutionLocation=this.gl.getUniformLocation(this.program,"u_resolution"),-1===this.positionLocation)throw new Error("unable to get attribute location for u_resolution");if(this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.setRectangle(this.gl,0,0,this.videoParam.MP4Width,this.videoParam.MP4Height),this.texcoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.STATIC_DRAW),this.renderingTexture=Zt(this.gl),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.renderingFbo=this.gl.createFramebuffer(),!this.renderingFbo)throw new Error("unable to create framebuffer");this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderingFbo),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.renderingTexture,0),this.originalVideoTexture=Zt(this.gl)}draw(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.originalVideoTexture),this.texImage2D(),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(this.program),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer);const t=this.gl.FLOAT;this.gl.vertexAttribPointer(this.positionLocation,2,t,false,0,0),this.gl.enableVertexAttribArray(this.texcoordLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.vertexAttribPointer(this.texcoordLocation,2,t,false,0,0),this.videoParam.hasAlpha&&this.gl.uniform2f(this.alphaStartLocation,this.videoParam.alphaStartX/this.videoParam.MP4Width/this.scale.x,this.videoParam.alphaStartY/this.videoParam.MP4Height/this.scale.y),this.gl.bindTexture(this.gl.TEXTURE_2D,this.originalVideoTexture),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderingFbo),this.gl.uniform2f(this.resolutionLocation,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.gl.uniform2f(this.scaleLocation,this.scale.x,this.scale.y),this.gl.viewport(0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight);const e=this.gl.TRIANGLES;this.gl.drawArrays(e,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.uniform2f(this.resolutionLocation,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.gl.viewport(this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height),this.gl.drawArrays(e,0,6)}clearRender(){this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}detectWebGLContext(){return(()=>{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))})()}texImage2D(){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.videoReader.getVideoElement())}setRectangle(t,e,i,r,s){const n=e,a=e+r,o=i,h=i+s;t.bufferData(t.ARRAY_BUFFER,new Float32Array([n,o,a,o,n,h,n,h,a,o,a,h]),t.STATIC_DRAW)}};ze=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Me(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&De(e,i,n),n})([Xt],ze);var Ne=Object.defineProperty,We=Object.getOwnPropertySymbols,He=Object.prototype.hasOwnProperty,je=Object.prototype.propertyIsEnumerable,Xe=(t,e,i)=>e in t?Ne(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;class Ke{static init(t,e,i={}){const r=((t,e)=>{for(var i in e||(e={}))He.call(e,i)&&Xe(t,i,e[i]);if(We)for(var i of We(e))je.call(e,i)&&Xe(t,i,e[i]);return t})({renderingMode:Wt.WebGL},i),s=new m,n=qt.fromArrayBuffer(t);let a;return s.mark("decode"),a=r.renderingMode===Wt.WebGL?new ze(n,e,r):new Le(n,e,r),a.setDebugData({decodePAGFile:s.measure("","decode")}),a}}const Ye=t({__name:"tm-pag",props:{width:{type:Number,default:750},height:{type:Number,default:500},url:{type:String,default:""},autoPlay:{type:Boolean,default:!0},loop:{type:Number,default:0},unit:{type:String,default:"rpx"}},setup(t){var h;const l=t,d=(null==(h=a())?void 0:h.proxy)??null,u="c_"+uni.$tm.u.getUid();return e((()=>{setTimeout((function(){new Promise(((t,e)=>{l.url&&new Promise(((t,e)=>{c(d,u).then((e=>{let i=e.node;i=e.node,t({ctx:i,pag:Ke})}))})).then((t=>{i({url:l.url,method:"GET",responseType:"arraybuffer",success(e){const i=Ke.init(e.data,t.ctx,{renderingMode:"Webgl",useScale:!0});i.setRepeatCount(l.loop),i.setScaleMode("LetterBox"),l.autoPlay&&i.play()},fail(t){console.error(":",t),e(t)}})}))}))}),100)})),(t,e)=>{const i=o;return r(),s(i,{type:"webgl",style:n({width:l.width+l.unit,height:l.height+l.unit}),"canvas-id":u,id:u},null,8,["style"])}}}),$e=t({__name:"index",setup:t=>(t,e)=>(r(),s(d,null,{default:h((()=>[l(Ye,{unit:"px",width:350,height:500,url:"https://cdn.tmui.design/pag/tmuiyear.pag"})])),_:1}))});export{$e as default};
