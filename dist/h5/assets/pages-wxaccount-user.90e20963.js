import{d as e,r as t,y as a,p as l,q as o,t as r,v as i,o as n,a as s,w as c,b as u,j as d,h as m,z as f,A as h,B as v,C as p,D as g,i as _}from"./index-6b165856.js";import{a as b,o as k,b as x,t as y}from"./tm-app.d6cf2f93.js";import{t as w}from"./tm-sheet.3639b36a.js";import{t as j}from"./tm-text.6c910eb0.js";import{t as C}from"./tm-modal.9a28df74.js";import{t as I}from"./tm-icon.65b53dc0.js";import{t as T}from"./tm-avatar.c34903e3.js";import{t as $}from"./tm-button.80fc9b3b.js";import{t as A}from"./tm-cell.5305407f.js";import{_ as z}from"./tm-statistic.vue_vue_type_script_setup_true_lang.0bc28af2.js";import"./tm-translate.1f1c80c0.js";import"./tm-overlay.a19aca82.js";import"./tm-image.vue_vue_type_script_setup_true_lang.b0e5c126.js";import"./tm-divider.vue_vue_type_script_setup_true_lang.cbbfcb4c.js";const O=e({__name:"user",setup(e){const O=t(""),U=t(!1),V=t(null),D=t(!1),J="https://tmui.design/api_v2",P="wss://tmui.design:8124/wss",q=()=>{O.value&&(r({title:"...",mask:!0}),uni.$tm.fetch.get(J+"/store/user/getUserInfo/",{},{header:{token:O.value}}).then((e=>{i();const t=e.data;if(200!=t.code)return o({title:"授权失效，重新登录"}),void uni.$tm.u.delCookie("token");let a=t.data;V.value=a})).catch((e=>{i(),console.error(e),o({title:"网络错误，请下拉刷新"})})))};function B(e="adunit-9a1c077dc510ea12",t=1,a=50){if(!O.value)return void m({url:"login"});r({title:"加载中"});let l=null;wx.createRewardedVideoAd&&(l=wx.createRewardedVideoAd({adUnitId:e}),l.onLoad((()=>{console.log("成功"),i()})),l.onError((e=>{i(),o({title:"请重试"})})),l.onClose((l=>{i(),l.isEnded?l.isEnded&&uni.$tm.fetch.post(J+"/store/user/addjifenByuser/",{jifen:a,desc:encodeURIComponent("查看激励视频广告获得积分"),type:t,adid:e},{header:{token:O.value}}).then((e=>{i();200==e.data.code?(o({title:`已添加${a}积分`}),q()):o({title:"添加积分失败"})})).catch((e=>{i(),o({title:"添加积分失败"})})):o({title:"提前结束"})}))),l&&l.show().catch((()=>{l.load().then((()=>l.show())).catch((e=>{console.error(e),i(),console.log("激励视频 广告显示失败"),o({title:"请重试"})}))}))}function E(){uni.$tm.u.scanCode(!0,"qrCode").then((e=>{return t=this,l=null,n=function*(){var t;if("scanCode:ok"==e.errMsg)try{let l=JSON.parse(e.result).data;yield(r({title:"...",mask:!0}),new Promise(((e,t)=>{U.value&&a(),h({url:P}),v((function(t){U.value=!0,i(),e()})),p((()=>{i(),o({title:"连接错误",icon:"none"}),t()})),g((function(e){console.log("收到服务器内容："+e.data);try{let t=JSON.parse(e.data);"info"==t.event&&o({title:t.message,icon:"none"}),"error"==t.event&&o({title:t.message,icon:"error"}),"success-wxauth"==t.event&&o({title:t.message,icon:"success"})}catch(t){}}))}))),t={event:"put-wxauth",data:l,code:O.value},f({data:JSON.stringify(t),fail(e){console.error(e,"授权错误。")}})}catch(l){o({title:"非法信息"})}else o({title:"识别失败"})},new Promise(((e,a)=>{var o=e=>{try{i(n.next(e))}catch(t){a(t)}},r=e=>{try{i(n.throw(e))}catch(t){a(t)}},i=t=>t.done?e(t.value):Promise.resolve(t.value).then(o,r);i((n=n.apply(t,l)).next())}));var t,l,n}))}return b((()=>{})),k((()=>{l({success:e=>{if("login:ok"!=e.errMsg)return void o({title:e.errMsg});let t=e.code;r({title:"...",mask:!0}),uni.$tm.fetch.get(J+"/store/web/wssWxAuth",{code:t}).then((e=>{i();const t=e.data;let a=e.header.tmui_sid;if(200!=t.code||!a)return o({title:"失败，请重试"}),void uni.$tm.u.delCookie("token");uni.$tm.u.setCookie("token",a),O.value=a,q()})).catch((e=>{i(),console.error(e),o({title:"授权失败"})}))},fail:e=>{o({title:"授权login失败"}),rej(e)}})})),x((()=>{U.value&&a()})),(e,t)=>{const a=_;return n(),s(y,null,{default:c((()=>[u(w,{round:3,margin:[32,32],color:"white"},{default:c((()=>[u(a,{class:"pa-0 flex flex-col flex-col-center-center"},{default:c((()=>[u(T,{size:160,round:24,label:V.value?V.value.nicename[0]:"T"},null,8,["label"]),u(a,{class:"pt-24 flex flex-col flex-col-center-center"},{default:c((()=>[u(j,{"font-size":32,label:V.value?"ID#"+V.value.tmzdy_tmuiAccountID:"ID#"},null,8,["label"]),u(j,{color:"grey","font-size":22,label:V.value?V.value.loginTime:"未登录哦"},null,8,["label"])])),_:1})])),_:1}),O.value?d("v-if",!0):(n(),s($,{key:0,height:100,block:"",margin:[0,24],round:25,label:"登录中..."}))])),_:1}),u(a,{class:"py-1"}),u(A,{round:3,margin:[32,0],label:"请通过下方的广告来获取",title:"可用积分",rightIcon:"",rightText:"36"},{rightText:c((()=>[u(z,{color:"primary",endVal:V.value?V.value.jifen:0},null,8,["endVal"])])),_:1}),u(A,{onClick:t[0]||(t[0]=e=>D.value=!0),margin:[32,24],round:3,title:"积分规则"}),u(a,{class:"mb-24"},{default:c((()=>[u(A,{onClick:E,margin:[32,0],round:3,title:"扫码登录模板市场"},{right:c((()=>[u(I,{color:"primary",name:"tmicon-qrcode"})])),_:1})])),_:1}),u(a,{class:"mx-32 mb-32 round-3 overflow"},{default:c((()=>[u(A,{onClick:t[1]||(t[1]=e=>B("adunit-9a1c077dc510ea12")),margin:[0,0],title:"视频广告类型一",rightText:"50积分"}),u(A,{onClick:t[2]||(t[2]=e=>B("adunit-e12de49d0a0916fa")),margin:[0,0],title:"视频广告类型二",rightText:"50积分"}),d(' <tm-cell @click="createChatuAd(\'adunit-8be03c2f96d2dcaf\')" :margin="[0, 0]" title="插图广告一" rightText="25积分">\r\n\t\t\t</tm-cell>\r\n\t\t\t<tm-cell @click="createChatuAd(\'adunit-4bdf1fd36a9c8a47\')" :margin="[0, 0]" title="插图广告二" rightText="25积分">\r\n\t\t\t</tm-cell> ')])),_:1}),d(' <tm-button @click="loginOut" v-if="token" block :margin="[32, 24]" color="red" label="退出登录"></tm-button> '),u(C,{color:"primary","ok-text":"我明白",text:"",height:650,border:2,okColor:"primary",hideCancel:"",splitBtn:"",linear:"bottom",title:"积分规则",show:D.value,"onUpdate:show":t[3]||(t[3]=e=>D.value=e)},{default:c((()=>[u(a,null,{default:c((()=>[u(j,{label:"1.在用户或者贡献群中，作者表杨突出贡献者。通过作者发放相关积分。"}),u(j,{label:"2.通过联系作者购买积分，积分比例为1元兑100。"}),u(j,{label:"3、通过广告获取积分规则: 看插屏广告得25个积分。看激励视频广告得50个积分。"}),u(j,{label:"4、当天超过8次以后每次只能获取8个积分"})])),_:1})])),_:1},8,["show"])])),_:1})}}});export{O as default};
