var t=Math.pow,e=(t,e,i)=>new Promise(((r,s)=>{var n=t=>{try{o(i.next(t))}catch(e){s(e)}},a=t=>{try{o(i.throw(t))}catch(e){s(e)}},o=t=>t.done?r(t.value):Promise.resolve(t.value).then(n,a);o((i=i.apply(t,e)).next())}));import{d as i,m as r,E as s,o as n,a,n as o,g as h,G as l,w as d,b as c}from"./index-6b165856.js";import{t as u}from"./tm-app.d6cf2f93.js";import{g as m}from"./getCanvas.fc323e9a.js";let p;try{p=performance.now.bind(performance)}catch(Qe){p=Date.now}class f{constructor(){this.startTime=p(),this.markers={}}reset(){this.startTime=p(),this.markers={}}mark(t){t?Object.keys(this.markers).find((e=>e===t))?console.log(`Clock.mark(): The specified marker name '${t}' already exists!`):this.markers[t]=p():console.log("Clock.mark(): An empty marker name was specified!")}measure(t,e){let i,r;if(t){if(!Object.keys(this.markers).find((e=>e===t)))return console.log(`Clock.measure(): The specified makerFrom '${t}' does not exist!`),0;i=this.markers[t]}else i=this.startTime;if(e){if(!Object.keys(this.markers).find((t=>t===e)))return console.log(`Clock.measure(): The specified makerTo '${e}' does not exist!`),0;r=this.markers[e]}else r=p();return r-i}}var g=(t=>(t[t.Unknown=0]="Unknown",t[t.Vector=1]="Vector",t[t.Bitmap=2]="Bitmap",t[t.Video=3]="Video",t))(g||{}),y=(t=>(t[t.End=0]="End",t[t.FontTables=1]="FontTables",t[t.VectorCompositionBlock=2]="VectorCompositionBlock",t[t.CompositionAttributes=3]="CompositionAttributes",t[t.ImageTables=4]="ImageTables",t[t.LayerBlock=5]="LayerBlock",t[t.LayerAttributes=6]="LayerAttributes",t[t.SolidColor=7]="SolidColor",t[t.TextSource=8]="TextSource",t[t.TextPathOption=9]="TextPathOption",t[t.TextMoreOption=10]="TextMoreOption",t[t.ImageReference=11]="ImageReference",t[t.CompositionReference=12]="CompositionReference",t[t.Transform2D=13]="Transform2D",t[t.MaskBlock=14]="MaskBlock",t[t.ShapeGroup=15]="ShapeGroup",t[t.Rectangle=16]="Rectangle",t[t.Ellipse=17]="Ellipse",t[t.PolyStar=18]="PolyStar",t[t.ShapePath=19]="ShapePath",t[t.Fill=20]="Fill",t[t.Stroke=21]="Stroke",t[t.GradientFill=22]="GradientFill",t[t.GradientStroke=23]="GradientStroke",t[t.MergePaths=24]="MergePaths",t[t.TrimPaths=25]="TrimPaths",t[t.Repeater=26]="Repeater",t[t.RoundCorners=27]="RoundCorners",t[t.Performance=28]="Performance",t[t.DropShadowStyle=29]="DropShadowStyle",t[t.InnerShadowStyle=30]="InnerShadowStyle",t[t.OuterGlowStyle=31]="OuterGlowStyle",t[t.InnerGlowStyle=32]="InnerGlowStyle",t[t.BevelAndEmbossStyle=33]="BevelAndEmbossStyle",t[t.SatinStyle=34]="SatinStyle",t[t.ColorOverlayStyle=35]="ColorOverlayStyle",t[t.GradientOverlayStyle=36]="GradientOverlayStyle",t[t.StrokeStyle=37]="StrokeStyle",t[t.TintEffect=38]="TintEffect",t[t.FillEffect=39]="FillEffect",t[t.StrokeEffect=40]="StrokeEffect",t[t.TritoneEffect=41]="TritoneEffect",t[t.DropShadowEffect=42]="DropShadowEffect",t[t.RadialWipeEffect=43]="RadialWipeEffect",t[t.DisplacementMapEffect=44]="DisplacementMapEffect",t[t.BitmapCompositionBlock=45]="BitmapCompositionBlock",t[t.BitmapSequence=46]="BitmapSequence",t[t.ImageBytes=47]="ImageBytes",t[t.ImageBytes2=48]="ImageBytes2",t[t.ImageBytes3=49]="ImageBytes3",t[t.VideoCompositionBlock=50]="VideoCompositionBlock",t[t.VideoSequence=51]="VideoSequence",t[t.LayerAttributesV2=52]="LayerAttributesV2",t[t.Count=53]="Count",t))(y||{});const v=t=>{const e=t.readUint16();let i=(63&e)>>>0;const r=e>>6;return 63===i&&(i=t.readUint32()),t.context.tagLevel<r&&(t.context.tagLevel=r),{code:r,length:i}};function w(t,e,i){let r=v(t);for(;r.code!==y.End;){const s=t.readBytes(r.length);i(s,r.code,e),t.context.tagLevel<s.context.tagLevel&&(t.context.tagLevel=s.context.tagLevel),r=v(t)}}const b={alpha:!0,depth:!1,stencil:!1,antialias:!1};var x=(t=>(t[t.Normal=0]="Normal",t[t.Multiply=1]="Multiply",t[t.Screen=2]="Screen",t[t.Overlay=3]="Overlay",t[t.Darken=4]="Darken",t[t.Lighten=5]="Lighten",t[t.ColorDodge=6]="ColorDodge",t[t.ColorBurn=7]="ColorBurn",t[t.HardLight=8]="HardLight",t[t.SoftLight=9]="SoftLight",t[t.Difference=10]="Difference",t[t.Exclusion=11]="Exclusion",t[t.Hue=12]="Hue",t[t.Saturation=13]="Saturation",t[t.Color=14]="Color",t[t.Luminosity=15]="Luminosity",t[t.DestinationIn=21]="DestinationIn",t[t.DestinationOut=22]="DestinationOut",t[t.DestinationATop=23]="DestinationATop",t[t.SourceIn=24]="SourceIn",t[t.SourceOut=25]="SourceOut",t[t.Xor=26]="Xor",t))(x||{}),S=(t=>(t[t.None=0]="None",t[t.Linear=1]="Linear",t[t.Bezier=2]="Bezier",t[t.Hold=3]="Hold",t))(S||{});const E=navigator&&/(ios|ipad|iphone)/.test(navigator.userAgent.toLowerCase()),T={red:0,green:0,blue:0},R={red:255,green:255,blue:255},P=()=>{console.error("PAG Verify Failed!")},C=t=>!!t||(console.error("PAG Verify Failed!"),!1),A=class{constructor(){this.id=0,this.width=0,this.height=0,this.duration=0,this.frameRate=30,this.backgroundColor=R,this.cacheID=0,this.cacheID=A.cacheIDCount,A.cacheIDCount+=1}type(){return g.Unknown}getStaticTimeRanges(){return[]}verify(){return C(this.width>0&&this.height>0&&this.duration>0&&this.frameRate>0)}};let V=A;V.cacheIDCount=1;class k extends V{constructor(){super(...arguments),this.hasAlpha=!1,this.sequences=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return g.Video}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}updateStaticTimeRanges(){if(!(this.duration<=1))if(this.sequences.length>0){let t=this.sequences[0];for(let i=1;i<this.sequences.length;i++){const e=this.sequences[i];e.frameRate>t.frameRate&&(t=e)}const e=this.frameRate/t.frameRate;for(const i of t.staticTimeRanges)i.start=Math.round(i.start*e),i.end=Math.round(i.end*e),this.staticTimeRanges.push(i)}else{const t={start:0,end:this.duration-1};this.staticTimeRanges.push(t)}}hasImageContent(){return!0}verify(){if(!super.verify()||this.sequences.length<=0)return P(),!1;for(const t of this.sequences)if(!t||!t.verify())return P(),!1;return!0}}class _{constructor(t,e){this.numerator=1,this.denominator=1,this.numerator=t,this.denominator=e}value(){return this.numerator/this.denominator}}const B=new _(1,1);class U{constructor(t,e){this.x=t,this.y=e}}const L=new U(0,0);var F=(t=>(t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.AlphaInverted=2]="AlphaInverted",t[t.Luma=3]="Luma",t[t.LumaInverted=4]="LumaInverted",t))(F||{}),D=(t=>(t[t.Unknown=0]="Unknown",t[t[void 0]=1]="undefined",t[t.Solid=2]="Solid",t[t.Text=3]="Text",t[t.Shape=4]="Shape",t[t.Image=5]="Image",t[t.PreCompose=6]="PreCompose",t))(D||{});class M{constructor(){this.id=0,this.parent=void 0,this.containingComposition=void 0,this.stretch=B,this.startTime=0,this.duration=0,this.autoOrientation=!1,this.transform=void 0,this.isActive=!0,this.blendMode=x.Normal,this.trackMatteType=0,this.trackMatteLayer=void 0,this.timeRemap=void 0,this.masks=void 0,this.effects=void 0,this.layerStyles=void 0,this.layerCache=void 0,this.maxScale=void 0}type(){return 0}excludeVaryingRanges(t){var e;if(null==(e=this.transform)||e.excludeVaryingRanges(t),void 0!==this.timeRemap&&this.timeRemap.excludeVaryingRanges(t),void 0!==this.masks)for(const i of this.masks)i.excludeVaryingRanges(t);if(void 0!==this.effects&&this.effects.length>0)for(const i of this.effects)i.excludeVaryingRanges(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const i of this.layerStyles)i.excludeVaryingRanges(t)}gotoFrame(t){var e;if(null==(e=this.transform)||e.gotoFrame(t),void 0!==this.timeRemap&&this.timeRemap.gotoFrame(t),void 0!==this.masks&&this.masks.length>0)for(const i of this.masks)i.gotoFrame(t);if(void 0!==this.effects&&this.effects.length>0)for(const i of this.effects)i.gotoFrame(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const i of this.layerStyles)i.gotoFrame(t)}verify(){if(!this.containingComposition||this.duration<=0||!this.transform)return P(),!1;if(!this.transform.verify())return P(),!1;if(this.masks&&this.masks.length>0)for(const t of this.masks)if(!t||!t.verify())return P(),!1;if(this.layerStyles&&this.layerStyles.length>0)for(const t of this.layerStyles)if(!t||!t.verify())return P(),!1;if(this.effects&&this.effects.length>0)for(const t of this.effects)if(!t||!t.verify())return P(),!1;return!0}getMaxScaleFactor(){if(void 0!==this.maxScale)return this.maxScale;this.maxScale=new U(1,1);const t=this.transform.scale;if(t.animatable()){const{keyframes:e}=t;let i=Math.abs(e[0].startValue.x),r=Math.abs(e[0].startValue.y);if(void 0!==e&&e.length>0)for(const t of e){const e=Math.abs(t.endValue.x),s=Math.abs(t.endValue.y);i<e&&(i=e),r<s&&(r=s)}this.maxScale.x=i,this.maxScale.y=r}else this.maxScale.x=Math.abs(t.value.x),this.maxScale.y=Math.abs(t.value.y);if(void 0!==this.parent){const t=this.parent.getMaxScaleFactor();this.maxScale.x*=t.x,this.maxScale.y*=t.y}return this.maxScale}}const I=.005,O=t=>({red:t.readUint8(),green:t.readUint8(),blue:t.readUint8()}),q=t=>t.readEncodedUint64(),G=t=>{const e=t.readFloat32(),i=t.readFloat32();return new U(e,i)},z=(t,e)=>{e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32(),e.duration=q(t),e.frameRate=t.readFloat32(),e.backgroundColor=O(t)};class N{constructor(){this.tagLevel=0,this.compositions=[],this.errorMessages=[]}throwException(t){this.errorMessages.push(t)}releaseCompositions(){const t=this.compositions.slice();return this.compositions=[],t}}const W="PAG file decode error!";class H{constructor(t,e){this._position=0,this.bitPosition=0,this.dataView=new DataView(t),this.littleEndian=!!e,this.context=new N}get length(){return this.dataView.byteLength}get bytesAvailable(){return this.dataView.byteLength-this._position}data(){return this.dataView.buffer}get position(){return this._position}alignWithBytes(){this.bitPosition=8*this._position}readBoolean(){const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),Boolean(t)}readChar(){if(this._position>=this.length)throw new Error(W);const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),String.fromCharCode(t)}readUint8(){if(this._position>=this.length)throw new Error(W);const t=this.dataView.getUint8(this._position);return this._position+=1,this.positonChanged(),t}readInt8(){if(this._position>=this.length)throw new Error(W);const t=this.dataView.getInt8(this._position);return this._position+=1,this.positonChanged(),t}readInt16(){if(this._position>=this.length-1)throw new Error(W);const t=this.dataView.getInt16(this._position,this.littleEndian);return this._position+=2,this.positonChanged(),t}readUint16(){if(this._position>=this.length-1)throw new Error(W);const t=this.dataView.getUint16(this._position,this.littleEndian);return this._position+=2,this.positonChanged(),t}readInt24(){if(this._position>=this.length-2)throw new Error(W);const e=this.dataView.getInt16(this._position,this.littleEndian),i=this.dataView.getInt8(this._position+2);return this._position+=3,this.positonChanged(),this.littleEndian?e+t(2,16)*i:t(2,16)*e+i}readUint24(){if(this._position>=this.length-2)throw new Error(W);const e=this.dataView.getUint16(this._position,this.littleEndian),i=this.dataView.getUint8(this._position+2);return this._position+=3,this.positonChanged(),this.littleEndian?e+t(2,16)*i:t(2,16)*e+i}readInt32(){if(this._position>=this.length-3)throw new Error(W);const t=this.dataView.getInt32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readUint32(){if(this._position>=this.length-3)throw new Error(W);const t=this.dataView.getUint32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readInt64(){if(this._position>=this.length-7)throw new Error(W);const e=this.dataView.getInt32(this._position,this.littleEndian),i=this.dataView.getInt32(this._position+4,this.littleEndian);return this._position+=8,this.positonChanged(),this.littleEndian?e+t(2,32)*i:t(2,32)*e+i}readUint64(){if(this._position>=this.length-7)throw new Error(W);const e=this.dataView.getUint32(this._position,this.littleEndian),i=this.dataView.getUint32(this._position+4,this.littleEndian);return this._position+=8,this.positonChanged(),this.littleEndian?e+t(2,32)*i:t(2,32)*e+i}readFloat32(){if(this._position>=this.length-3)throw new Error(W);const t=this.dataView.getFloat32(this._position,this.littleEndian);return this._position+=4,this.positonChanged(),t}readDouble(){if(this._position>=this.length-7)throw new Error(W);const t=this.dataView.getFloat64(this._position,this.littleEndian);return this._position+=8,this.positonChanged(),t}readUTF8String(){if(this._position>=this.length)throw new Error(W);let t="",e=0;for(let i=this._position;i<this.length&&0!==this.dataView.getUint8(i);i++)t+=`%${this.dataView.getUint8(i).toString(16)}`,e+=1;return this._position+=e,this.positonChanged(),decodeURIComponent(t)}readEncodedUint32(){let t=0,e=0;for(let i=0;i<32;i+=7){if(this._position>=this.length)throw Error("readEncodedUint32 End of file was encountered.");if(e=this.dataView.getUint8(this._position),this._position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChanged(),t}readEncodeInt32(){const t=this.readEncodedUint32(),e=t>>1;return(1&t)>0?-e:e}readEncodedUint64(){let t=0,e=0;for(let i=0;i<64;i+=7){if(this._position>=this.length)throw Error("readEncodedUint64 End of file was encountered.");if(e=this.dataView.getUint8(this._position),this._position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChanged(),t}readEncodeInt64(){const t=this.readEncodedUint64(),e=t<<0;return(1&t)>0?-e:e}readBytes(t){const e=t||this.length-this._position;if(this._position>this.length-e)throw new Error(W);const i=this.dataView.buffer.slice(this._position,this._position+e);return this._position+=e,this.positonChanged(),new H(i,this.littleEndian)}readUBits(t){const e=[0,1,3,7,15,31,63,127,255];let i=0;if(this.bitPosition>8*this.length-t)throw new Error(W);let r=0;for(;r<t;){const s=Math.floor(.125*this.bitPosition),n=this.bitPosition%8;let a=this.dataView.getUint8(s)>>n;const o=Math.min(8-n,t-r);a&=e[o],i|=a<<r,r+=o,this.bitPosition+=o}return this.bitPositionChanged(),i}readBits(t){let e=this.readUBits(t);e<<=32-t;return e<<0>>32-t}readNumBits(){return this.readUBits(5)+1}readInt32List(t){const e=this.readNumBits(),i=new Array(t);for(let r=0;r<t;r++)i[r]=this.readBits(e);return i}readUint32List(t){const e=this.readNumBits(),i=new Array(t);for(let r=0;r<t;r++)i[r]=this.readUBits(e);return i}readBitBoolean(){return 0!==this.readUBits(1)}readFloatList(t,e){const i=this.readNumBits(),r=new Array(t);for(let s=0;s<t;s++)r[s]=this.readBits(i)*e;return r}bitPositionChanged(){this._position=Math.ceil(.125*this.bitPosition)}positonChanged(){this.bitPosition=8*this._position}}class j{constructor(t,e){this.length=0,this.data=t,this.length=e}}class X{constructor(){this.isKeyframe=!1,this.frame=0,this.fileBytes=new j(new H(new ArrayBuffer(0)),0)}}class K{constructor(){this.composition=void 0,this.id=0,this.width=0,this.height=0,this.frameRate=0,this.frameCount=0,this.isKeyFrameFlags=[]}verify(){return C(void 0!==this.composition&&this.width>0&&this.height>0&&this.frameRate>0)}}class Y extends K{constructor(){super(...arguments),this.alphaStartX=0,this.alphaStartY=0,this.frames=[],this.headers=[],this.staticTimeRanges=[]}verify(){if(!super.verify()||this.frames.length<=0)return P(),!1;for(const t of this.frames)if(!t||!t.fileBytes)return P(),!1;for(const t of this.headers)if(!t)return P(),!1;return!0}getVideoWidth(){let t=this.alphaStartX+this.width;return t%2==1&&(t+=1),t}getVideoHeight(){let t=this.alphaStartY+this.height;return t%2==1&&(t+=1),t}}const $=t=>{const e=t.readEncodedUint32(),i=t.readBytes(e);if(0===e)throw new Error("Read start code with length 0!");const r=new ArrayBuffer(e+4);return new DataView(r).setUint32(0,e),((t,e,i,r,s)=>{if(e>=t.byteLength||r>=i.byteLength||i.byteLength-r>t.byteLength-e||s>i.byteLength)return;const n=new Uint8Array(t),a=new Uint8Array(i,r,s);n.set(a,e)})(r,4,i.data(),0,e),new j(new H(r),e+4)},Z=(t,e,i)=>{const{composition:r}=i;switch(e){case y.CompositionAttributes:z(t,r);break;case y.VideoSequence:{const e=((t,e)=>{const i=new Y;i.width=t.readEncodeInt32(),i.height=t.readEncodeInt32(),i.frameRate=t.readFloat32(),e&&(i.alphaStartX=t.readEncodeInt32(),i.alphaStartY=t.readEncodeInt32());const r=$(t),s=$(t);i.headers.push(r,s),i.frameCount=t.readEncodedUint32();for(let n=0;n<i.frameCount;n++){const e=new X;e.isKeyframe=t.readBitBoolean(),i.frames.push(e)}for(let n=0;n<i.frameCount;n++){const e=i.frames[n];e.frame=q(t),e.fileBytes=$(t)}if(t.bytesAvailable>0){const e=t.readEncodedUint32();for(let r=0;r<e;r++){const e={start:0,end:0};e.start=q(t),e.end=q(t),i.staticTimeRanges.push(e)}}return i})(t,i.hasAlpha);e.composition=r,r.sequences.push(e);break}}};var J=(t=>(t[t.Unknown=0]="Unknown",t[t.Tint=1]="Tint",t[t.Fill=2]="Fill",t[t.Stroke=3]="Stroke",t[t.Tritone=4]="Tritone",t[t.DropShadow=5]="DropShadow",t[t.RadialWipe=6]="RadialWipe",t[t.DisplacementMap=7]="DisplacementMap",t))(J||{});function Q(t,e,i){if(i<e)return;for(let r=t.length-1;r>=0;r--){const s=t[r];if(!(s.end<e||s.start>i)){if(s.start<e&&s.end>i){const n={start:i+1,end:s.end};s.end=e-1,n.end>n.start&&t.splice(r+1,0,n),s.end<=s.start&&t.splice(r,1);break}s.start>=e&&s.end<=i?t.splice(r,1):s.start<e?(s.end=e-1,s.end<=s.start&&t.splice(r,1)):(s.start=i+1,s.end<=s.start&&t.splice(r,1))}}}function tt(t,e){for(let i=t.length-1;i>=0;i--){const r=t[i];if(r.start===e||r.end<=e)break;if(r.start<e&&r.end>e){const s={start:e,end:r.end};r.end=e-1,s.end>s.start&&t.splice(i+1,0,s),r.end<=r.start&&t.splice(i,1);break}}}class et extends V{constructor(){super(...arguments),this.layers=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return g.Vector}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}verify(){if(!super.verify())return P(),!1;for(const t of this.layers)if(!t||!t.verify())return P(),!1;return!0}updateStaticTimeRanges(){if(this.duration>1){const t={start:0,end:this.duration-1};this.staticTimeRanges=[t];for(const e of this.layers){if(this.staticTimeRanges.length<=0)break;e.excludeVaryingRanges(this.staticTimeRanges),tt(this.staticTimeRanges,e.startTime),tt(this.staticTimeRanges,e.startTime+e.duration)}}}}class it{constructor(t){this.value=t}animatable(){return!1}excludeVaryingRanges(t){}gotoFrame(t){}}class rt{static createDefaultTransform2D(){return new rt}constructor(){this.anchorPoint=new it(L),this.position=new it(L),this.xPosition=new it(0),this.yPosition=new it(0),this.scale=new it(new U(1,1)),this.rotation=new it(0),this.opacity=new it(255)}excludeVaryingRanges(t){this.anchorPoint.excludeVaryingRanges(t),void 0!==this.position?this.position.excludeVaryingRanges(t):(this.xPosition.excludeVaryingRanges(t),this.yPosition.excludeVaryingRanges(t)),this.scale.excludeVaryingRanges(t),this.rotation.excludeVaryingRanges(t),this.opacity.excludeVaryingRanges(t)}gotoFrame(t){this.anchorPoint.gotoFrame(t),void 0!==this.position?this.position.gotoFrame(t):(this.xPosition.gotoFrame(t),this.yPosition.gotoFrame(t)),this.scale.gotoFrame(t),this.rotation.gotoFrame(t),this.opacity.gotoFrame(t)}verify(){return void 0!==this.anchorPoint&&(void 0!==this.position||void 0!==this.xPosition&&void 0!==this.yPosition)&&void 0!==this.scale&&void 0!==this.rotation&&void 0!==this.opacity}}class st extends M{constructor(){super(...arguments),this.composition=void 0,this.compositionStartTime=0,this.staticTimeRanges=void 0,this.staticTimeRangeUpdated=!1}static wrap(t){const e=new st;e.duration=t.duration;const i=new rt;return e.transform=i,e.composition=t,e}type(){return D.PreCompose}excludeVaryingRanges(t){super.excludeVaryingRanges(t),t&&0!==t.length&&this.updateStaticTimeRanges()}gotoFrame(t){super.gotoFrame(t)}verify(){return!!super.verify()&&!!this.composition}updateStaticTimeRanges(){var t;if(this.staticTimeRangeUpdated)return;this.staticTimeRangeUpdated=!0;const e=null==(t=this.composition)?void 0:t.getStaticTimeRanges();if(e){for(let t=e.length-1;t>=0;t--){const i=e[t];i.start+=this.compositionStartTime,i.end+=this.compositionStartTime,i.end<=this.startTime?e.pop():i.start<this.startTime?i.start=0:i.start>=this.startTime+this.duration-1?e.pop():i.end>this.startTime+this.duration-1&&(i.end=this.startTime+this.duration-1)}this.staticTimeRanges=e}}}class nt extends M{constructor(){super(...arguments),this.contents=[]}type(){return D.Shape}excludeVaryingRanges(t){super.excludeVaryingRanges(t);for(const e of this.contents)e.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t);for(const e of this.contents)e.gotoFrame(t)}verify(){if(!super.verify())return!1;for(const t of this.contents)if(void 0===t||!t.verify())return!1;return!0}}class at extends M{constructor(){super(...arguments),this.solidColor=T,this.width=0,this.height=0}type(){return D.Solid}excludeVaryingRanges(t){super.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t)}verify(){return super.verify()?C(this.width>0&&this.height>0):(P(),!1)}}class ot extends M{type(){return D.undefined}}class ht{constructor(){this.startTime=0,this.endTime=0,this.interpolationType=S.Hold,this.bezierOut=[],this.bezierIn=[],this.spatialOut=L,this.spatialIn=L}initialize(){}getValue(t){return this.startValue}containsTime(t){return t>=this.startTime&&t<this.endTime}}class lt extends it{constructor(t){if(!t||0===t.length)throw new Error("keyframes is required");if(void 0===t[0].startValue)throw new Error("startValue is required");super(t[0].startValue),this.keyframes=t,this.lastKeyframeIndex=0;for(const e of t)e.initialize()}animatable(){return!0}excludeVaryingRanges(t){for(const e of this.keyframes)switch(e.interpolationType){case S.Bezier:case S.Linear:Q(t,e.startTime,e.endTime-1);break;default:tt(t,e.startTime),tt(t,e.endTime)}}gotoFrame(t){let e=this.keyframes[this.lastKeyframeIndex];if(e.containsTime(t))this.value=e.getValue(t);else{if(t<e.startTime)for(;this.lastKeyframeIndex>0&&(this.lastKeyframeIndex-=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););else for(;this.lastKeyframeIndex<this.keyframes.length-1&&(this.lastKeyframeIndex+=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););e=this.keyframes[this.lastKeyframeIndex],void 0!==e.startValue&&t<=e.startTime?this.value=e.startValue:void 0!==e.endValue&&t>=e.endTime?this.value=e.endValue:this.value=e.getValue(t)}}}var dt=(t=>(t[t.Value=0]="Value",t[t.FixedValue=1]="FixedValue",t[t.SimpleProperty=2]="SimpleProperty",t[t.DiscreteProperty=3]="DiscreteProperty",t[t.MultiDimensionProperty=4]="MultiDimensionProperty",t[t.SpatialProperty=5]="SpatialProperty",t[t.BitFlag=6]="BitFlag",t[t.Custom=7]="Custom",t))(dt||{});const ct=(t,e,i)=>{const r=i,s=[];if(!r.configs||0===r.configs.length)return e;for(const a of r.configs){const e=gt(t,a);s.push(e)}t.alignWithBytes();let n=0;for(const a of r.configs){const i=s[n],r=a.key;a.readAttribute(t,i,e,r),n+=1}return e};class ut{constructor(t,e,i){this.attributeType=e,this.defaultValue=i,this.key=t}readAttribute(t,e,i,r){}readValue(t){}readValueList(t,e,i){}dimensionality(){return 1}newKeyframe(t){return new ht}}const mt=(t,e,i,r,s)=>{6===s.attributeType?i[r]=e.exist:1===s.attributeType?i[r]=s.readValue(t):0===s.attributeType?i[r]=ft(t,s,e):i[r]=pt(t,s,e)},pt=(t,e,i)=>{let r;if(i.exist)if(i.animatable){const s=yt(t,e,i);if(!s||0===s.length)throw new Error("Wrong number of keyframes!");vt(t,s,e),wt(t,s,e),i.hasSpatial,r=new lt(s)}else r=new it(ft(t,e,i));else r=new it(e.defaultValue);return r},ft=(t,e,i)=>i.exist?e.readValue(t):e.defaultValue,gt=(t,e)=>{const i={exist:!1,animatable:!1,hasSpatial:!1},{attributeType:r}=e;return 1===r?(i.exist=!0,i):(i.exist=t.readBitBoolean(),i.exist&&0!==r&&6!==r&&7!==r?(i.animatable=t.readBitBoolean(),i.animatable&&5===r?(i.hasSpatial=t.readBitBoolean(),i):i):i)},yt=(t,e,i)=>{const r=[],s=t.readEncodedUint32();for(let n=0;n<s;n++){let s;if(3===e.attributeType)s=new ht;else{const r=t.readUBits(2);r===S.Hold?s=new ht:(s=e.newKeyframe(i),s.interpolationType=r)}r.push(s)}return r},vt=(t,e,i)=>{const r=e.length;e[0].startTime=q(t);for(let a=0;a<r;a++){const i=q(t);e[a].endTime=i,a<r-1&&(e[a+1].startTime=i)}const s=[];i.readValueList(t,s,r+1);let n=0;e[0].startValue=s[n],n+=1;for(let a=0;a<r;a++){const t=s[n];n+=1,e[a].endValue=t,a<r-1&&(e[a+1].startValue=t)}},wt=(t,e,i)=>{const r=4===i.attributeType?i.dimensionality():1,s=t.readNumBits();for(const n of e){if(n.interpolationType!==S.Bezier)continue;let e,i;for(let a=0;a<r;a++)e=t.readBits(s)*I,i=t.readBits(s)*I,n.bezierOut.push({x:e,y:i}),e=t.readBits(s)*I,i=t.readBits(s)*I,n.bezierIn.push({x:e,y:i})}};function bt(t,e,i){return t+(e-t)*i}class xt{getInterpolation(t){return t}}class St extends ht{initialize(){super.initialize(),this.interpolationType===S.Bezier||(this.xInterpolator=new xt,this.yInterpolator=new xt)}getValue(t){var e,i,r,s;const n=(t-this.startTime)/(this.endTime-this.startTime),a=null!=(i=null==(e=this.xInterpolator)?void 0:e.getInterpolation(n))?i:n,o=null!=(s=null==(r=this.yInterpolator)?void 0:r.getInterpolation(n))?s:n;return{x:bt(this.startValue.x,this.endValue.x,a),y:bt(this.startValue.y,this.endValue.y,o)}}}class Et extends ht{initialize(){this.interpolationType===S.Bezier||(this.interpolator=new xt)}getProgress(t){var e,i;const r=(t-this.startTime)/(this.endTime-this.startTime);return null!=(i=null==(e=this.interpolator)?void 0:e.getInterpolation(r))?i:r}getValue(t){const e=this.getProgress(t);return bt(this.startValue,this.endValue,e)}}class Tt extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return t.readFloat32()}readValueList(t,e,i){for(let r=0;r<i;r++)e.push(this.readValue(t))}dimensionality(){return 1}newKeyframe(t){return new Et}}class Rt extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return t.readBoolean()}readValueList(t,e,i){for(let r=0;r<i;r++)e.push(t.readBitBoolean())}dimensionality(){return 1}newKeyframe(t){return new ht}}class Pt extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return t.readUint8()}readValueList(t,e,i){const r=t.readUint32List(i);for(let s=0;s<i;s++)e.push(r[s])}dimensionality(){return 1}newKeyframe(t){return new Et}}class Ct extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return q(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Et}}class At extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return G(t)}readValueList(t,e,i){if(this.attributeType===dt.SpatialProperty){const r=t.readFloatList(2*i,.05);for(let t=0;t<i;t++)e[t]||(e[t]=new U(0,0)),e[t].x=r[t]}else for(let r=0;r<i;r++)e[r]=G(t)}dimensionality(){return 2}newKeyframe(t){return this.attributeType===dt.MultiDimensionProperty?new St:new Et}}class Vt extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return(t=>{const e=t.readEncodeInt32(),i=t.readEncodedUint32();return new _(e,i)})(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Et}}class kt extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return(t=>{const e=t.readEncodedUint32();if(0===e)throw new Error("Layer ID is 0");const i=new M;return i.id=e,i})(t)}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Et}}const _t={tagCode:y.LayerAttributes,configs:[new Rt("isActive",dt.BitFlag,!0),new Rt("autoOrientation",dt.BitFlag,!1),new kt("parent",dt.Value,void 0),new Vt("stretch",dt.Value,B),new Ct("startTime",dt.Value,0),new Pt("blendMode",dt.Value,x.Normal),new Pt("trackMatteType",dt.Value,F.None),new Tt("timeRemap",dt.SimpleProperty,0),new Ct("duration",dt.FixedValue,0)]},Bt={tagCode:y.LayerAttributesV2,configs:[new Rt("isActive",dt.BitFlag,!0),new Rt("autoOrientation",dt.BitFlag,!1),new kt("parent",dt.Value,void 0),new Vt("stretch",dt.Value,B),new Ct("startTime",dt.Value,0),new Pt("blendMode",dt.Value,x.Normal),new Pt("trackMatteType",dt.Value,F.None),new Tt("timeRemap",dt.SimpleProperty,0),new Ct("duration",dt.FixedValue,0),new class extends ut{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,r){mt(t,e,i,r,this)}readValue(t){return t.readUTF8String()}readValueList(t,e,i){for(let r=0;r<i;r++)e[r]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Et}}("name",dt.Value,"")]},Ut={tagCode:y.Transform2D,configs:[new At("anchorPoint",dt.SpatialProperty,L),new At("position",dt.SpatialProperty,L),new Tt("xPosition",dt.SimpleProperty,0),new Tt("yPosition",dt.SimpleProperty,0),new At("scale",dt.MultiDimensionProperty,new U(1,1)),new Tt("rotation",dt.SimpleProperty,0),new Pt("opacity",dt.SimpleProperty,255)]};y.MaskBlock;const Lt=(t,e,i)=>{switch(e){case y.LayerAttributes:ct(t,i,_t),i.duration<=0&&(i.duration=1);break;case y.LayerAttributesV2:ct(t,i,Bt),i.duration<=0&&(i.duration=1);break;case y.Transform2D:i.transform=new rt,ct(t,i.transform,Ut),i.transform.position.animatable()||i.transform.position.value!==L||!i.transform.xPosition.animatable()&&0===i.transform.xPosition.value&&!i.transform.yPosition.animatable()&&0===i.transform.yPosition.value?(i.transform.xPosition=new it(0),i.transform.yPosition=new it(0)):i.transform.position=new it(L);break;case y.SolidColor:i.type()===D.Solid&&function(t,e){e.solidColor=O(t),e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32()}(t,i);break;case y.CompositionReference:i.type()===D.PreCompose&&function(t,e){const i=t.readEncodedUint32();i>0&&(e.composition=new V,e.composition.id=i),e.compositionStartTime=q(t)}(t,i)}},Ft=(t,e,i)=>{switch(e){case y.CompositionAttributes:z(t,i);break;case y.LayerBlock:i.layers.push((t=>{let e;switch(t.readUint8()){case D.undefined:e=new ot;break;case D.Solid:e=new at;break;case D.Shape:e=new nt;break;case D.PreCompose:e=new st;break;default:e=new M}return e.id=t.readEncodedUint32(),w(t,e,Lt),e})(t))}},Dt=t=>{if(t&&0===t.length)return;const e=new Map;for(const r of t)r&&(Mt(r),e.set(r.id,r));let i=0;for(const r of t)if(r){if(void 0!==r.parent){const t=r.parent.id,i=e.get(t);void 0!==i&&(r.parent=i)}if(i>0&&It(r.trackMatteType)&&(r.trackMatteLayer=t[i-1]),void 0!==r.effects&&r.effects.length>0)for(const t of r.effects)t&&(t.type(),J.DisplacementMap);i+=1}},Mt=t=>{var e;if(!t||!t.masks||0===t.masks.length)return;const i=new Map;for(const r of t.masks)r&&i.set(r.id,r);if(null==(e=t.effects)||e.forEach((t=>{if(t){if(void 0!==t.maskReferences&&t.maskReferences.length>0){const e=new Array;t.maskReferences.forEach((t=>{const r=t.id,s=i.get(r);void 0!==s&&e.push(s)})),t.maskReferences=e}switch(t.type()){case J.Fill:if(void 0!==t.fillMask){const e=t.fillMask.id,r=i.get(e);void 0!==r&&(t.fillMask=r)}break;case J.Stroke:{const e=t;if(void 0!==e.path){const t=e.path.id,r=i.get(t);void 0!==r&&(e.path=r)}break}}}})),t.type()===D.Text){const{pathOption:e}=t;if(null==e?void 0:e.path){const t=e.path.id,r=i.get(t);void 0!==r&&(e.path=r)}}},It=t=>{switch(t){case F.Alpha:case F.AlphaInverted:return!0;default:return!1}};function Ot(t,e,i){switch(e){case y.VectorCompositionBlock:i.compositions.push((t=>{const e=new et;return e.id=t.readEncodedUint32(),w(t,e,Ft),Dt(e.layers),e})(t));break;case y.VideoCompositionBlock:i.compositions.push((t=>{const e=new k;return e.id=t.readEncodedUint32(),e.hasAlpha=t.readBoolean(),w(t,{composition:e,hasAlpha:e.hasAlpha},Z),e})(t))}}const qt=t=>{const e=Gt(t),{context:i}=e;w(e,i,Ot),function(t){if(!t||0===t.length)return;const e=new Map;t.forEach((t=>{t&&e.set(t.id,t)})),t.forEach((t=>{if(t&&t.type()===g.Vector){const i=t;i.layers&&i.layers.length>0&&i.layers.forEach((t=>{t.containingComposition=i;const r=t;if(r.type()===D.PreCompose&&r.composition){const t=e.get(r.composition.id);t&&(r.composition=t)}}))}}))}(i.compositions);const r=i.releaseCompositions();return(t=>{let e=t.length>0;for(const i of t)if(!i||!i.verify()){e=!1;break}if(!e)throw new Error("Verify composition failed!")})(r),{compositions:r,tagLevel:i.tagLevel}},Gt=t=>{if(t.length<11)throw new Error("PAG file is invalid!");const e=t.readInt8(),i=t.readInt8(),r=t.readInt8();if(80!==e||65!==i||71!==r)throw new Error("invalid PAG header!");return t.readInt8(),t.readUint32(),t.readInt8(),t.readBytes()};class zt{constructor(t,e){this.tagLevel=1,this.compositions=[],this.numLayers=0,this.scaledTimeRange={start:0,end:0},this.mainComposition=t[t.length-1],this.scaledTimeRange.start=0,this.scaledTimeRange.end=this.mainComposition.duration,this.compositions=t,this.duration=this.mainComposition.duration,this.implDuration=1e3*this.mainComposition.duration/this.mainComposition.frameRate;for(const i of t)if(i.type()===g.Vector)for(const t of i.layers)t.type()!==D.PreCompose&&(this.numLayers+=1);else this.numLayers+=1;this.tagLevel=e}static fromArrayBuffer(t){if(!t||0===t.byteLength)throw new Error("Can't read empty array buffer!");const e=new H(t,!0),{compositions:i,tagLevel:r}=qt(e);return new zt(i,r)}getVideoSequence(){const t=this.mainComposition.type();return t===g.Video?Nt(this.mainComposition):t===g.Vector?Wt(this.mainComposition):void 0}}const Nt=t=>{if(!t.sequences||0===t.sequences.length)throw new Error("PAGFile has no BMP video sequence!");return t.sequences[t.sequences.length-1]},Wt=t=>{const e=Ht(t);if(e.length>1)throw new Error("PAGFile has more than one BMP video sequence!");if(e.length<1)throw new Error("PAGFile has no BMP video sequence!");const i=e[0];return Nt(i)},Ht=t=>{const e=[];return t.layers.forEach((t=>{if(t.type()!==D.PreCompose)return;const{composition:i}=t;(null==i?void 0:i.type())!==g.Video?(null==i?void 0:i.type())===g.Vector&&e.push(...Ht(i)):e.push(i)})),e};var jt=(t=>(t.Canvas2D="2d",t.WebGL="WebGL",t))(jt||{}),Xt=(t=>(t.onAnimationStart="onAnimationStart",t.onAnimationEnd="onAnimationEnd",t.onAnimationCancel="onAnimationCancel",t.onAnimationRepeat="onAnimationRepeat",t.onAnimationUpdate="onAnimationUpdate",t.onAnimationPlay="onAnimationPlay",t.onAnimationPause="onAnimationPause",t))(Xt||{}),Kt=(t=>(t.None="None",t.Stretch="Stretch",t.LetterBox="LetterBox",t.Zoom="Zoom",t))(Kt||{});function Yt(t){let e=Object.getOwnPropertyNames(t.prototype).filter((e=>"constructor"!==e&&"function"==typeof t.prototype[e]));const i=(t,e)=>{const i=t[e];t[e]=function(...t){if(!this.destroyed)return i.call(this,...t);console.error(`Don't call ${e} of the PAGView that is destroyed.`)}};e.forEach((e=>i(t.prototype,e)))}const $t=(t,e,i)=>{const r=t.createProgram();if(!r)throw new Error("Failed to create program.");const s=Zt(t,e,t.VERTEX_SHADER);if(!s)throw new Error("Failed to create vertex shader.");t.attachShader(r,s);const n=Zt(t,i,t.FRAGMENT_SHADER);if(!n)throw new Error("Failed to create fragment shader.");t.attachShader(r,n),t.linkProgram(r);const a=t.getProgramInfoLog(r);a&&console.log(a);const o=t.getShaderInfoLog(s);o&&console.log(o);const h=t.getShaderInfoLog(n);return h&&console.log(h),r},Zt=(t,e,i)=>{const r=t.createShader(i);if(!r)throw new Error("Failed to create shader.");return t.shaderSource(r,e),t.compileShader(r),r},Jt=t=>t.replace(/^\s+|\s+$/g,""),Qt=t=>{const e=t.createTexture();if(!e)throw new Error("Failed to create texture.");return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),e};class te{constructor(){this.listenersMap={}}on(t,e){void 0===this.listenersMap[t]&&(this.listenersMap[t]=[]),this.listenersMap[t].push(e)}off(t,e){const i=this.listenersMap[t];if(void 0===i)return;if(void 0===e)return void delete this.listenersMap[t];const r=i.findIndex((t=>t===e));i.splice(r,1)}emit(t,...e){const i=this.listenersMap[t];if(void 0===i||i.length<1)return!1;for(const r of i)r(...e);return!0}}var ee=Object.defineProperty,ie=Object.getOwnPropertyDescriptor,re=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable,ae=(t,e,i)=>e in t?ee(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,oe=(t,e)=>{for(var i in e||(e={}))se.call(e,i)&&ae(t,i,e[i]);if(re)for(var i of re(e))ne.call(e,i)&&ae(t,i,e[i]);return t};let he=class{constructor(t,e,i){this.canvasSize={width:0,height:0},this.playing=!1,this.viewportSize={x:0,y:0,width:0,height:0,scaleX:1,scaleY:1},this.destroyed=!1,this.renderTimer=null,this.repeatCount=0,this.viewScaleMode=Kt.LetterBox,this.debugData={FPS:0,decodePAGFile:0,createDir:0,coverMP4:0,writeFile:0,createDecoder:0,getFrame:0,draw:0};const r=t.getVideoSequence();if(!r)throw new Error("PAGFile has no BMP video sequence!");delete r.composition,this.videoSequence=r,this.canvas=e,this.videoParam=((t,e)=>({width:t.mainComposition.width,height:t.mainComposition.height,hasAlpha:e.alphaStartX>0||e.alphaStartY>0,alphaStartX:e.alphaStartX,alphaStartY:e.alphaStartY,sequenceWidth:e.width,sequenceHeight:e.height,MP4Width:(e.width+e.alphaStartX)%2==0?e.width+e.alphaStartX:e.width+e.alphaStartX+1,MP4Height:(e.height+e.alphaStartY)%2==0?e.height+e.alphaStartY:e.height+e.alphaStartY+1}))(t,r),this.eventManager=new te,this.renderingMode=i.renderingMode||jt.WebGL,this.updateSize(i.useScale),this.setScaleMode()}isPlaying(){return this.playing}isDestroyed(){return this.destroyed}duration(){return this.videoSequence.frameCount/this.videoSequence.frameRate}frameRate(){return this.videoSequence.frameRate}setRepeatCount(t=1){this.repeatCount=t<0?-1:t-1}addListener(t,e){return this.eventManager.on(t,e)}removeListener(t,e){return this.eventManager.off(t,e)}scaleMode(){return this.viewScaleMode}setScaleMode(t=Kt.LetterBox){switch(this.viewScaleMode=t,t){case Kt.None:this.viewportSize={x:0,y:this.renderingMode===jt.WebGL?this.canvas.height-this.videoParam.height:0,width:this.videoParam.width,height:this.videoParam.height,scaleX:1,scaleY:1};break;case Kt.Stretch:this.viewportSize={x:0,y:0,width:this.canvas.width,height:this.canvas.height,scaleX:this.canvas.width/this.videoParam.sequenceWidth,scaleY:this.canvas.height/this.videoParam.sequenceHeight};break;case Kt.LetterBox:{const t=this.canvas.width/this.videoParam.sequenceWidth,e=this.canvas.height/this.videoParam.sequenceHeight,i=Math.min(t,e);this.viewportSize={x:(this.canvas.width-this.videoParam.sequenceWidth*i)/2,y:(this.canvas.height-this.videoParam.sequenceHeight*i)/2,width:this.videoParam.sequenceWidth*i,height:this.videoParam.sequenceHeight*i,scaleX:i,scaleY:i}}break;case Kt.Zoom:{const t=this.canvas.width/this.videoParam.sequenceWidth,e=this.canvas.height/this.videoParam.sequenceHeight,i=Math.max(t,e);this.viewportSize={x:(this.canvas.width-this.videoParam.sequenceWidth*i)/2,y:(this.canvas.height-this.videoParam.sequenceHeight*i)/2,width:this.videoParam.sequenceWidth*i,height:this.videoParam.sequenceHeight*i,scaleX:i,scaleY:i}}}}updateSize(t=!0){if(!this.canvas)throw new Error("Canvas element is not found!");let e;const i=getComputedStyle(this.canvas),r={width:Number(i.width.replace("px","")),height:Number(i.height.replace("px",""))};if(r.width>0&&r.height>0)e=r;else{const t={width:Number(this.canvas.style.width.replace("px","")),height:Number(this.canvas.style.height.replace("px",""))};e=t.width>0&&t.height>0?t:{width:this.canvas.width,height:this.canvas.height}}if(!t)return this.canvas.width=this.canvas.width||e.width,void(this.canvas.height=this.canvas.height||e.height);this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`,this.canvas.width=e.width*window.devicePixelRatio,this.canvas.height=e.height*window.devicePixelRatio}getDebugData(){return this.debugData}setDebugData(t){this.debugData=oe(oe({},this.debugData),t)}loadContext(){}clearRender(){}};he=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?ie(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&ee(e,i,n),n})([Yt],he);const le=2082873600,de=t=>{const e=[];for(let i=0;i<t.length;i++)e.push(t.charCodeAt(i));return e},ce=t=>[t>>24,t>>16&255,t>>8&255,255&t],ue=(t,...e)=>{let i=8,r=e.length;const s=r;for(;r;)r-=1,i+=e[r].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=255&i,n.set(t,4),r=0,i=8;r<s;++r)n.set(e[r],i),i+=e[r].byteLength;return n};class me{constructor(t){this.param=t}ftyp(){return ue(de("ftyp"),new Uint8Array(de("isom")),new Uint8Array([0,0,0,1]),new Uint8Array(de("isom")),new Uint8Array(de("iso2")),new Uint8Array(de("avc1")),new Uint8Array(de("mp41")))}moov(){const t=this.param.tracks.map((t=>this.trak(t))).reverse();return ue(de("moov"),this.mvhd(),...t,this.mvex())}moof(){return ue(de("moof"),this.mfhd(),this.traf())}mdat(){const t=new Uint8Array(this.param.track.len);let e=0;return this.param.videoSequence.headers.forEach((i=>{t.set(new Uint8Array(i.data.data()),e),e+=i.length})),this.param.videoSequence.frames.forEach(((i,r)=>{t.set(new Uint8Array(i.fileBytes.data.data()),e),e+=i.fileBytes.length})),ue(de("mdat"),t)}mvhd(){return ue(de("mvhd"),new Uint8Array([0,0,0,0,...ce(le),...ce(le),...ce(this.param.timescale),...ce(this.param.duration),0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]))}trak(t){return ue(de("trak"),this.tkhd(t),this.edts(t),this.mdia(t))}tkhd(t){return ue(de("tkhd"),new Uint8Array([0,0,0,1,...ce(le),...ce(le),...ce(t.id),0,0,0,0,...ce(t.duration),0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,t.width>>8&255,255&t.width,0,0,t.height>>8&255,255&t.height,0,0]))}edts(t){return ue(de("edts"),this.elst(t))}elst(t){return ue(de("elst"),new Uint8Array([0,0,0,0,...ce(1),...ce(t.duration),...ce(t.implicitOffset*Math.floor(t.duration/t.samples.length)),0,1,0,0]))}mdia(t){return ue(de("mdia"),this.mdhd(),this.hdlr(),this.minf(t))}mdhd(){return ue(de("mdhd"),new Uint8Array([0,0,0,0,...ce(le),...ce(le),...ce(this.param.timescale),...ce(0),85,196,0,0]))}hdlr(){return ue(de("hdlr"),new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]))}minf(t){return ue(de("minf"),this.vmhd(),this.dinf(),this.stbl(t))}vmhd(){return ue(de("vmhd"),new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}dinf(){return ue(de("dinf"),this.dref())}dref(){return ue(de("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]))}stbl(t){return ue(de("stbl"),this.stsd(t),this.stts(t),this.ctts(t),this.stss(t),this.stsc(),this.stsz(),this.stco())}stsd(t){return ue(de("stsd"),new Uint8Array([0,0,0,0,0,0,0,1]),this.avc1(t))}avc1(t){const e=[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255];return ue(de("avc1"),new Uint8Array(e),this.avcc(t))}avcc(t){let e=[],i=[];t.sps.forEach((t=>{const i=t.length-4;e.push(i>>>8&255),e.push(255&i),e=e.concat(Array.prototype.slice.call(new Uint8Array(t.data.data(),4)))})),t.pps.forEach((t=>{const e=t.length-4;i.push(e>>>8&255),i.push(255&e),i=i.concat(Array.prototype.slice.call(new Uint8Array(t.data.data(),4)))}));const r=[1,e[3],e[4],e[5],255,224|t.sps.length].concat(e).concat([t.pps.length]).concat(i);return ue(de("avcC"),new Uint8Array(r))}stts(t){return ue(de("stts"),new Uint8Array([0,0,0,0,...ce(1),...ce(t.samples.length),...ce(Math.floor(t.duration/t.samples.length))]))}ctts(t){const e=t.pts.length,i=Math.floor(t.duration/e),r=[0,0,0,0,...ce(e)];for(let s=0;s<e;s++){r.push(...ce(1));const e=s*i,n=(t.pts[s]+t.implicitOffset)*i;r.push(...ce(n-e))}return ue(de("ctts"),new Uint8Array(r))}stss(t){const e=t.samples.filter((t=>t.flags.isKeyFrame)).map((t=>t.index+1)),i=[0,0,0,0,...ce(e.length)];return e.forEach((t=>{i.push(...ce(t))})),ue(de("stss"),new Uint8Array(i))}stsc(){return ue(de("stsc"),new Uint8Array([0,0,0,0,0,0,0,0]))}stsz(){return ue(de("stsz"),new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]))}stco(){return ue(de("stco"),new Uint8Array([0,0,0,0,0,0,0,0]))}mvex(){const t=this.param.tracks.map((t=>this.trex(t))).reverse();return ue(de("mvex"),...t)}trex(t){return ue(de("trex"),new Uint8Array([0,0,0,0,t.id>>24,t.id>>16&255,t.id>>8&255,255&t.id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}mfhd(){return ue(de("mfhd"),new Uint8Array([0,0,0,0,this.param.sequenceNumber>>24,this.param.sequenceNumber>>16&255,this.param.sequenceNumber>>8&255,255&this.param.sequenceNumber]))}traf(){const t=this.sdtp();return this.param.offset=t.length+72,ue(de("traf"),this.tfhd(),this.tfdt(),this.trun(),t)}tfhd(){return ue(de("tfhd"),new Uint8Array([0,0,0,0,...ce(this.param.track.id)]))}tfdt(){return ue(de("tfdt"),new Uint8Array([0,0,0,0,...ce(this.param.baseMediaDecodeTime)]))}trun(){const t=(this.param.track.samples||[]).length,e=12+16*t;this.param.offset+=8+e;const i=[0,0,15,1,...ce(t),...ce(this.param.offset)];return this.param.track.samples.forEach((t=>{const{duration:e,size:r,flags:s,cts:n}=t;i.push(...ce(e)),i.push(...ce(r)),i.push(s.isLeading<<2|s.dependsOn),i.push(s.isDependedOn<<6|s.hasRedundancy<<4|0|s.isNonSync),i.push(61440&s.degradPrio),i.push(15&s.degradPrio),i.push(...ce(n))})),ue(de("trun"),new Uint8Array(i))}sdtp(){const t=new Uint8Array(4+this.param.track.samples.length);return this.param.track.samples.forEach(((e,i)=>{t[i+4]=e.flags.dependsOn<<4|e.flags.isDependedOn<<2|e.flags.hasRedundancy})),ue(de("sdtp"),t)}}var pe=Object.defineProperty,fe=Object.getOwnPropertySymbols,ge=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable,ve=(t,e,i)=>e in t?pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,we=(t,e)=>{for(var i in e||(e={}))ge.call(e,i)&&ve(t,i,e[i]);if(fe)for(var i of fe(e))ye.call(e,i)&&ve(t,i,e[i]);return t};const be=t=>{const e=E?Ee(t):t,i=xe(e);if(!i||0===i.len)throw new Error("mp4Track is empty");const r={offset:0,tracks:[i],track:i,duration:i.duration,timescale:i.timescale,sequenceNumber:1,baseMediaDecodeTime:0,nalusBytesLen:i.len,videoSequence:e},s=new me(r);return(t=>{let e=0;for(const s of t)e+=s.byteLength;const i=new Uint8Array(e);let r=0;for(const s of t)i.set(s,r),r+=s.byteLength;return i})([s.ftyp(),s.moov(),s.moof(),s.mdat()])},xe=t=>{if(t.headers.length<2)throw new Error("Bad header data in video sequence!");if(0===t.frames.length)throw new Error("There is no frame data in the video sequence!");const e={id:1,type:"video",timescale:6e3,duration:Math.floor(6e3*t.frames.length/t.frameRate),width:t.getVideoWidth(),height:t.getVideoHeight(),sps:[t.headers[0]],pps:[t.headers[1]],implicitOffset:Se(t.frames),len:0,pts:[],samples:[]},i=t.headers.reduce(((t,e)=>t+e.length),0),r=e.duration/t.frames.length;return t.frames.forEach(((t,s)=>{var n;let a=null!=(n=t.fileBytes.length)?n:0;0===s&&(a+=i),e.len+=a,e.pts.push(t.frame),e.samples.push({index:s,size:a,duration:r,cts:(t.frame+e.implicitOffset-s)*r,flags:{isKeyFrame:t.isKeyframe,isNonSync:t.isKeyframe?0:1,dependsOn:t.isKeyframe?2:1,isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}})})),e},Se=t=>Math.max(...t.map(((t,e)=>e-t.frame))),Ee=t=>{const e=t.frames.length;for(let i=0;i<t.frames.length;i++){const r=we({},t.frames[i]);if(r.isKeyframe&&i>0)break;r.frame+=e,t.frames.push(r)}return t};let Te={};const Re=(t,e,i,r=!1)=>{var s;e in Te||(Te[e]=[]),null==(s=Te[e])||s.push({node:t,handler:i,capture:r}),t.addEventListener(e,i,r)};var Pe=Object.defineProperty,Ce=Object.getOwnPropertyDescriptor;const Ae=navigator&&/MicroMessenger/i.test(navigator.userAgent),Ve=t=>e(void 0,null,(function*(){Ae&&window.WeixinJSBridge&&(yield new Promise((t=>{window.WeixinJSBridge.invoke("getNetworkType",{},(()=>{t()}),(()=>{t()}))})));try{yield t.play()}catch(e){throw new Error(e.message)}}));let ke=class{constructor(t){this.destroyed=!1,this.frameRate=0,this._duration=t.frameCount/t.frameRate,this.frameRate=t.frameRate}static create(t){const e=new ke(t),i=e.load(t);return{videoReader:e,debugData:i}}getVideoElement(){return this.videoElement}progress(){return Math.round(this.videoElement.currentTime/this._duration*100)/100}duration(){return this._duration}currentTime(){return this.videoElement.currentTime||0}start(){return Ve(this.videoElement)}pause(){var t;null==(t=this.videoElement)||t.pause()}seek(t){return new Promise((e=>{const i=()=>{var t,r,s,n,a,o,h;t=this.videoElement,s=i,(r="seeked")in Te&&(s?(null==(n=Te[r])||n.filter((({node:e,handler:i})=>e===t&&i===s)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(r,e,i))),Te[r]=null==(a=Te[r])?void 0:a.filter((({node:e,handler:i})=>!(e===t&&i===s)))):(null==(o=Te[r])||o.filter((({node:e})=>e===t)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(r,e,i))),Te[r]=null==(h=Te[r])?void 0:h.filter((({node:e})=>e!==t)))),e()};Re(this.videoElement,"seeked",i),this.videoElement.currentTime=t}))}addListener(t,e){Re(this.videoElement,t,e)}removeAllListeners(){var t;t=this.videoElement,Object.keys(Te).forEach((e=>{var i,r;const s=e;null==(i=Te[s])||i.filter((({node:e})=>e===t)).forEach((({node:t,handler:e,capture:i})=>t.removeEventListener(s,e,i))),Te[s]=null==(r=Te[s])?void 0:r.filter((({node:e})=>e!==t))}))}getFrameData(t){}clearCallback(){}destroy(){this.removeAllListeners(),this.videoElement=void 0,this.destroyed=!0}load(t){this.videoElement=document.createElement("video"),this.videoElement.style.display="none",this.videoElement.muted=!0,this.videoElement.playsInline=!0;const e=new f,i=be(t);return e.mark("coverMP4"),this.videoElement.src=URL.createObjectURL(new Blob([i],{type:"video/mp4"})),this.videoElement.load(),{coverMP4:e.measure("","coverMP4")}}};ke=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Ce(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Pe(e,i,n),n})([Yt],ke);var _e=Object.defineProperty,Be=Object.getOwnPropertyDescriptor;let Ue=class extends he{constructor(t,e,i){super(t,e,i),this.fpsBuffer=[],this.currentFrame=-1,this.needSeek=!1,this.videoReader=this.createVideoReader(this.videoSequence)}play(){return e(this,null,(function*(){this.playing||(this.playing=!0,yield this.videoReader.start(),yield this.flushLoop(),0===this.getProgress()&&this.eventManager.emit(Xt.onAnimationStart),this.eventManager.emit(Xt.onAnimationPlay))}))}pause(){this.playing&&(this.videoReader.pause(),this.clearTimer(),this.playing=!1,this.eventManager.emit(Xt.onAnimationPause))}stop(){this.videoReader.pause(),this.videoReader.seek(0),this.clearRender(),this.playing=!1,this.eventManager.emit(Xt.onAnimationCancel)}destroy(){this.clearTimer(),this.clearRender(),this.canvas=null,this.videoReader.destroy(),this.destroyed=!0}getProgress(){return this.currentFrame/this.videoSequence.frameCount}setProgress(t){if(t<0||t>1)throw new Error("progress must be between 0.0 and 1.0!");const e=Math.round(t*this.videoSequence.frameCount);this.currentFrame!==e&&(this.needSeek=!0,this.currentFrame=e)}flush(){return this.flushInternal(!0)}draw(){}createVideoReader(t){const{videoReader:e,debugData:i}=ke.create(t);return this.setDebugData(i),E||e.addListener("ended",(()=>{this.repeat()})),e}repeat(){return e(this,null,(function*(){return 0===this.repeatCount?(this.setProgress(1),yield this.flushInternal(!0),this.videoReader.pause(),this.clearTimer(),this.playing=!1,this.eventManager.emit("onAnimationEnd"),!1):(this.repeatCount-=1,E?yield this.videoReader.seek(0):this.videoReader.start(),this.eventManager.emit("onAnimationRepeat"),!0)}))}flushLoop(){return this.renderTimer=window.requestAnimationFrame((()=>{this.flushLoop()})),E&&this.duration()-this.videoReader.currentTime()<=1/this.frameRate()&&this.repeat(),this.flushInternal(!1)}clearTimer(){this.renderTimer&&(window.cancelAnimationFrame(this.renderTimer),this.renderTimer=null)}updateFPS(){let t;try{t=performance.now()}catch(Qe){t=Date.now()}this.fpsBuffer=this.fpsBuffer.filter((e=>t-e<=1e3)),this.fpsBuffer.push(t),this.setDebugData({FPS:this.fpsBuffer.length})}flushInternal(t){return e(this,null,(function*(){const e=new f;this.needSeek?(t?yield this.videoReader.seek(this.currentFrame/this.frameRate()):this.videoReader.seek(this.currentFrame/this.frameRate()),this.needSeek=!1):this.currentFrame=Math.floor(this.videoReader.currentTime()*this.frameRate()),this.draw(),e.mark("draw"),this.setDebugData({draw:e.measure("","draw")}),this.updateFPS(),this.eventManager.emit(Xt.onAnimationUpdate)}))}};Ue=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Be(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&_e(e,i,n),n})([Yt],Ue);var Le=Object.defineProperty,Fe=Object.getOwnPropertyDescriptor;let De=class extends Ue{constructor(t,e,i){var r;super(t,e,i);const s=null==(r=this.canvas)?void 0:r.getContext("2d");if(!s)throw new Error("Can't get 2d context!");this.context=s,this.renderCanvas2D=document.createElement("canvas"),this.renderCanvas2D.width=this.videoParam.MP4Width,this.renderCanvas2D.height=this.videoParam.MP4Height;const n=this.renderCanvas2D.getContext("2d");if(!n)throw new Error("Can't get 2d context!");this.renderCanvas2DContext=n}draw(){if(this.videoParam.hasAlpha){this.renderCanvas2DContext.clearRect(0,0,this.renderCanvas2D.width,this.renderCanvas2D.height),this.renderCanvas2DContext.drawImage(this.videoReader.getVideoElement(),0,0,this.renderCanvas2D.width,this.renderCanvas2D.height);const t=this.renderCanvas2DContext.getImageData(0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),e=this.renderCanvas2DContext.getImageData(this.videoParam.alphaStartX,this.videoParam.alphaStartY,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),i=t.data.length/4;for(let r=0;r<i;r++)t.data[4*r+3]=e.data[4*r+0];this.renderCanvas2DContext.clearRect(0,0,this.renderCanvas2D.width,this.renderCanvas2D.height),this.renderCanvas2DContext.putImageData(t,0,0,0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.renderCanvas2D,0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight,this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height)}else this.context.drawImage(this.videoReader.getVideoElement(),0,0,this.videoParam.MP4Width,this.videoParam.MP4Height,this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height)}clearRender(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};De=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Fe(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Le(e,i,n),n})([Yt],De);const Me="\n      attribute vec2 a_position;\n      attribute vec2 a_texCoord;\n      \n      uniform vec2 u_resolution;\n      uniform vec2 u_scale;\n      \n      varying vec2 v_texCoord;\n    \n      \n      void main() {\n         // convert the rectangle from pixels to 0.0 to 1.0\n         vec2 zeroToOne = a_position / u_resolution;\n      \n         // convert from 0->1 to 0->2\n         vec2 zeroToTwo = zeroToOne * 2.0;\n      \n         // convert from 0->2 to -1->+1 (clipspace)\n         vec2 clipSpace = zeroToTwo - 1.0;\n      \n         gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n      \n         // pass the texCoord to the fragment shader\n         // The GPU will interpolate this value between points.\n         v_texCoord = a_texCoord / u_scale;\n      }\n        ";var Ie=Object.defineProperty,Oe=Object.getOwnPropertyDescriptor,qe=Object.getOwnPropertySymbols,Ge=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable,Ne=(t,e,i)=>e in t?Ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;let We=class extends Ue{constructor(t,e,i){var r;super(t,e,i),this.scale={x:1,y:1},this.positionLocation=0,this.texcoordLocation=0,this.alphaStartLocation=null,this.scaleLocation=null,this.resolutionLocation=null,this.positionBuffer=null,this.texcoordBuffer=null,this.originalVideoTexture=null,this.renderingTexture=null,this.renderingFbo=null;const s=null==(r=this.canvas)?void 0:r.getContext("webgl",((t,e)=>{for(var i in e||(e={}))Ge.call(e,i)&&Ne(t,i,e[i]);if(qe)for(var i of qe(e))ze.call(e,i)&&Ne(t,i,e[i]);return t})({},b));if(!s)throw new Error("Can't get WebGL context!");this.gl=s,this.videoParam.hasAlpha?this.program=$t(this.gl,Jt(Me),Jt("\n      precision mediump float;\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      uniform vec2 v_alphaStart;\n      \n      void main() {\n         vec4 color = texture2D(u_image, v_texCoord);\n         vec4 alpha = texture2D(u_image, vec2(v_texCoord.x + v_alphaStart.x, v_texCoord.y + v_alphaStart.y));\n         gl_FragColor = vec4(color.rgb * alpha.r, alpha.r);\n      }     \n         ")):this.program=$t(this.gl,Jt(Me),Jt("\n      precision mediump float;\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      \n      void main() {\n         gl_FragColor = texture2D(u_image, v_texCoord);\n      }\n         ")),this.loadContext()}loadContext(){if(!this.program)throw new Error("program is not initialized");if(this.positionLocation=this.gl.getAttribLocation(this.program,"a_position"),-1===this.positionLocation)throw new Error("unable to get attribute location for a_position");if(this.scaleLocation=this.gl.getUniformLocation(this.program,"u_scale"),-1===this.scaleLocation)throw new Error("unable to get attribute location for u_scale");if(this.texcoordLocation=this.gl.getAttribLocation(this.program,"a_texCoord"),-1===this.texcoordLocation)throw new Error("unable to get attribute location for a_texCoord");if(this.videoParam.hasAlpha&&(this.alphaStartLocation=this.gl.getUniformLocation(this.program,"v_alphaStart"),!this.alphaStartLocation))throw new Error("unable to get attribute location for v_alphaStart");if(this.resolutionLocation=this.gl.getUniformLocation(this.program,"u_resolution"),-1===this.positionLocation)throw new Error("unable to get attribute location for u_resolution");if(this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.setRectangle(this.gl,0,0,this.videoParam.MP4Width,this.videoParam.MP4Height),this.texcoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.STATIC_DRAW),this.renderingTexture=Qt(this.gl),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.renderingFbo=this.gl.createFramebuffer(),!this.renderingFbo)throw new Error("unable to create framebuffer");this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderingFbo),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.renderingTexture,0),this.originalVideoTexture=Qt(this.gl)}draw(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.originalVideoTexture),this.texImage2D(),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(this.program),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer);const t=this.gl.FLOAT;this.gl.vertexAttribPointer(this.positionLocation,2,t,false,0,0),this.gl.enableVertexAttribArray(this.texcoordLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.vertexAttribPointer(this.texcoordLocation,2,t,false,0,0),this.videoParam.hasAlpha&&this.gl.uniform2f(this.alphaStartLocation,this.videoParam.alphaStartX/this.videoParam.MP4Width/this.scale.x,this.videoParam.alphaStartY/this.videoParam.MP4Height/this.scale.y),this.gl.bindTexture(this.gl.TEXTURE_2D,this.originalVideoTexture),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.renderingFbo),this.gl.uniform2f(this.resolutionLocation,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.gl.uniform2f(this.scaleLocation,this.scale.x,this.scale.y),this.gl.viewport(0,0,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight);const e=this.gl.TRIANGLES;this.gl.drawArrays(e,0,6),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.uniform2f(this.resolutionLocation,this.videoParam.sequenceWidth,this.videoParam.sequenceHeight),this.gl.viewport(this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height),this.gl.drawArrays(e,0,6)}clearRender(){this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}detectWebGLContext(){return(()=>{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))})()}texImage2D(){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.videoReader.getVideoElement())}setRectangle(t,e,i,r,s){const n=e,a=e+r,o=i,h=i+s;t.bufferData(t.ARRAY_BUFFER,new Float32Array([n,o,a,o,n,h,n,h,a,o,a,h]),t.STATIC_DRAW)}};We=((t,e,i,r)=>{for(var s,n=r>1?void 0:r?Oe(e,i):e,a=t.length-1;a>=0;a--)(s=t[a])&&(n=(r?s(e,i,n):s(n))||n);return r&&n&&Ie(e,i,n),n})([Yt],We);var He=Object.defineProperty,je=Object.getOwnPropertySymbols,Xe=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable,Ye=(t,e,i)=>e in t?He(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;class $e{static init(t,e,i={}){const r=((t,e)=>{for(var i in e||(e={}))Xe.call(e,i)&&Ye(t,i,e[i]);if(je)for(var i of je(e))Ke.call(e,i)&&Ye(t,i,e[i]);return t})({renderingMode:jt.WebGL},i),s=new f,n=zt.fromArrayBuffer(t);let a;return s.mark("decode"),a=r.renderingMode===jt.WebGL?new We(n,e,r):new De(n,e,r),a.setDebugData({decodePAGFile:s.measure("","decode")}),a}}const Ze=i({__name:"tm-pag",props:{width:{type:Number,default:750},height:{type:Number,default:500},url:{type:String,default:""},autoPlay:{type:Boolean,default:!0},loop:{type:Number,default:0},unit:{type:String,default:"rpx"}},setup(t){var e,i;const d=t,c=null!=(i=null==(e=h())?void 0:e.proxy)?i:null,u="c_"+uni.$tm.u.getUid();return r((()=>{setTimeout((function(){new Promise(((t,e)=>{d.url&&new Promise(((t,e)=>{m(c,u).then((e=>{let i=e.node;i=e.node,t({ctx:i,pag:$e})}))})).then((t=>{s({url:d.url,method:"GET",responseType:"arraybuffer",success(e){const i=$e.init(e.data,t.ctx,{renderingMode:"Webgl",useScale:!0});i.setRepeatCount(d.loop),i.setScaleMode("LetterBox"),d.autoPlay&&i.play()},fail(t){console.error(":",t),e(t)}})}))}))}),100)})),(t,e)=>{const i=l;return n(),a(i,{type:"webgl",style:o({width:d.width+d.unit,height:d.height+d.unit}),"canvas-id":u,id:u},null,8,["style"])}}}),Je=i({__name:"index",setup:t=>(t,e)=>(n(),a(u,null,{default:d((()=>[c(Ze,{unit:"px",width:350,height:500,url:"https://cdn.tmui.design/pag/tmuiyear.pag"})])),_:1}))});export{Je as default};
