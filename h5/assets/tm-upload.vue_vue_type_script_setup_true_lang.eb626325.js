var e=Object.defineProperty,t=(t,l,s)=>(((t,l,s)=>{l in t?e(t,l,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[l]=s})(t,"symbol"!=typeof l?l+"":l,s),s);import{W as l,aC as s,aD as i,d as o,c as a,r as n,Q as r,R as u,o as f,a as c,w as d,b as p,e as m,f as h,F as y,u as g,n as x,N as v,k as w,g as b,aE as C,j as S,O as F,V as _}from"./index-5c06cf16.js";import{_ as k}from"./tm-image.vue_vue_type_script_setup_true_lang.f325e7c1.js";import{t as z}from"./tm-text.fdd4f0a8.js";import{t as A}from"./tm-icon.5716c798.js";import{t as V}from"./tm-sheet.2873fe67.js";var N=(e=>(e[e.upload=0]="upload",e[e.uploading=1]="uploading",e[e.fail=2]="fail",e[e.success=3]="success",e[e.max=4]="max",e))(N||{});function T(e=3){return Number(Number(Math.random().toString().substr(3,e)+Date.now()).toString(8))}class j{constructor(e){t(this,"filelist",[]),t(this,"isStop",!1),t(this,"index",0),t(this,"config",{}),t(this,"uploadobj",null);let l={maxSize:10485760,maxFile:9,fileType:["album","camera"],fileList:[],autoUpload:!0,header:{},formData:{},formName:"file"};l={...l,...arguments[0]??{}},this.config=l,this.addFile(l.fileList),delete this.config.fileList}async beforeChooesefile(){return!0}async chooesefileAfter(e){return e}async chooesefileSuccess(e){return e}delete(e){let t=this.filelist.findIndex((t=>t.uid==e.uid));if(t>-1){let e=[...this.filelist];e.splice(t,1),this.filelist=[...e]}return this.filelist}async clear(){this.stop(),this.filelist=[]}setFileStatus(e){let t=this.filelist.findIndex((t=>t.uid==e.uid));if(t>-1){let l=[...this.filelist];l.splice(t,1,e),this.filelist=[...l]}}async chooesefile(){let e=this;return new Promise((async(t,s)=>{await e.beforeChooesefile()?l({count:e.config.maxFile,sourceType:e.config.fileType,fail:e=>{s("取消选择")},success:async l=>{if(0==l.tempFilePaths.length)return void s("未选择");let i=l.tempFilePaths,o=l.tempFiles,a=[];i.forEach(((t,l)=>{let s=o[l].size>e.config.maxSize;a.push({url:t,status:s?"超过大小":"待上传",progress:s?100:0,uid:T(),statusCode:s?4:0,response:null,name:o[l].name??""})}));let n=await e.chooesefileAfter(a);Array.isArray(n)&&"object"==typeof n?(e.filelist.push(...n),e.chooesefileSuccess(n),t(n),e.config.autoUpload&&setTimeout((function(){e.start()}),500)):s("chooesefileAfter:函数过滤，没有返回文件列表。")}}):t([])}))}async chooseMPH5weixinFile(){let e=this;return new Promise(((t,l)=>{var i,o=s,a={count:e.config.maxfile,type:e.config.type,extension:e.config.extension};e.config.extension&&Array.isArray(e.config.extension)&&0!=(null==(i=e.config.extension)?void 0:i.length)||delete a.extension,o({...a,fail:e=>{console.error(e),uni.$tm.toast("已取消选择"),l(e)},success:l=>{if(0==l.tempFiles.length)return void uni.$tm.toast("未选择");let s=l.tempFiles,i=[];s.forEach(((t,l)=>{let o=s[l].size>e.config.maxsize,a=t.name||"";a&&(a=a.substr(a.lastIndexOf(".")+1).toLocaleLowerCase()),i.push({url:t.path,name:t.name||"默认文件名称",type:a,status:o?"超过大小":"待上传",progress:o?100:0,fileId:guid(),statusCode:o?4:0,data:null})})),e.filelist.push(...i),e.selected(e.filelist),e.config.isAuto&&e.start(),t(e.filelist)}})}))}setConfig(e){this.config={...this.config,...e??{}}}addFile(e=[]){if("object"!=typeof e&&!Array.isArray(e))return;let t=new Set(this.filelist.map((e=>e.uid))),l=new Set(this.filelist.map((e=>e.url))),s=e.map((e=>({...e,status:(null==e?void 0:e.status)??"待上传",statusCode:(null==e?void 0:e.statusCode)??0,uid:(null==e?void 0:e.uid)??T(),progress:(null==e?void 0:e.progress)??0,name:(null==e?void 0:e.name)??"",response:(null==e?void 0:e.response)??null,url:(null==e?void 0:e.url)??""}))).filter((e=>!t.has(e.uid)&&!l.has(e.url)));this.filelist.push(...s)}beforeSuccess(e){return Promise.resolve(!0)}beforeStart(e){return Promise.resolve(!0)}progress(e){}fail(e){}success(e,t){}complete(e){}uploadComplete(e){}awaitTime(){return new Promise((e=>{setTimeout((()=>{e(!0)}),20)}))}async start(){if(this.filelist.length<=0)return void console.error("未选择图片,已取消上传");let e=this;this.index=0,this.isStop=!1,await async function t(){var l,s;if(e.isStop)return;let o=e.filelist[e.index];if(!o||void 0===o)return void e.uploadComplete(e.filelist);if(!(await e.beforeStart(o)))return o.statusCode=2,o.status="不允许上传",e.filelist.splice(e.index,1,o),e.index++,e.setFileStatus(o),e.fail(o),e.complete(o),void t();if(3==o.statusCode||1==o.statusCode||4==o.statusCode||2==o.statusCode)return e.index++,void t();o.statusCode=1,o.status="上传中...",e.setFileStatus(o);const a=e.uploadobj=i({url:String(e.config.hostUrl),name:(null==(l=e.config)?void 0:l.formName)??"file",header:(null==(s=e.config)?void 0:s.header)??{},filePath:o.url,formData:{name:o.name,...e.config.formData},success:async t=>{var l;if(e.isStop)return;o.response=t.data;let s=await e.beforeSuccess(o);const i=(null==(l=e.config)?void 0:l.statusCode)??200;if(t.statusCode!=i||!s)return o.statusCode=2,o.status="上传失败",e.fail(o),e.setFileStatus(o),void e.index++;o.statusCode=3,o.status="上传成功",e.setFileStatus(o),e.success(o,e.filelist),e.index++},fail:t=>{e.isStop||(o.statusCode=2,o.status="上传失败",e.setFileStatus(o),e.fail(o),e.index++)},complete:async l=>{e.isStop||(await e.awaitTime(),e.complete(o),t())}});if(a){let t=e.filelist[e.index];a.onProgressUpdate((async l=>{e.isStop||(t.progress=l.progress,t.statusCode=1,t.status="上传中...",e.setFileStatus(t),e.progress(t))}))}}()}stop(){this.isStop=!0,null!=this.uploadobj&&this.uploadobj.abort()}}const D=o({__name:"tm-upload",props:{followTheme:{type:[Boolean,String],default:!0},width:{type:Number,default:700},rows:{type:Number,default:5},imageHeight:{type:Number,default:140},imageModel:{type:String,default:"scaleToFill"},defaultValue:{type:Array,default:()=>[]},modelValue:{type:Array,default:()=>[]},color:{type:String,default:"primary"},header:{type:Object,default:()=>{}},formData:{type:Object,default:()=>{}},maxFile:{type:Number,default:9},maxSize:{type:Number,default:10485760},url:{type:String,default:"",required:!0},formName:{type:String,default:"file"},autoUpload:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},onRemove:{type:[Function,Boolean],default:()=>e=>!0},onStart:{type:[Function,Boolean],default:()=>e=>!0},onSuccessAfter:{type:[Function,Boolean],default:()=>e=>!0},beforeChooese:{type:[Function,Boolean],default:()=>e=>!0},chooesefileAfter:{type:[Function,Boolean],default:()=>e=>!0},showSort:{type:Boolean,default:!1},fileType:{type:Array,default:["album","camera"]},statusCode:{type:Number,default:200},showStatus:{type:Boolean,default:!0}},emits:["success","fail","complete","change","remove","uploadComplete","update:modelValue"],setup(e,{expose:t,emit:l}){var s;const i=e;null==(s=b())||s.proxy;let o=NaN;const T=a((()=>i.width/i.rows)),D=a((()=>i.imageHeight)),P=new j({formName:i.formName,hostUrl:i.url,autoUpload:i.autoUpload,fileList:L(i.defaultValue),header:i.header,formData:i.formData,maxFile:i.maxFile,maxSize:i.maxSize,fileType:i.fileType,statusCode:i.statusCode}),B=n([]),U=a((()=>i.disabled)),I=a((()=>i.disabled||B.value.length>=i.maxFile));function E(e,t,s){if(0==t&&"prev"==s||t==B.value.length-1&&"next"==s)return;let i="prev"==s?t-1:t+1,o=r(B.value[t]),a=r(B.value[i]),n=uni.$tm.u.deepClone(r(P.filelist));n.splice(t,1,a),n.splice(i,1,o),P.filelist=[...n],B.value=[...P.filelist],l("update:modelValue",n)}function L(e=[]){return e.map((e=>{let t={url:""};return"string"==typeof e?t.url=e:t={...e},t={statusCode:(null==e?void 0:e.statusCode)??N.success,status:(null==e?void 0:e.status)??"上传成功",progress:(null==e?void 0:e.progress)??100,...t},t}))}function $(){U.value||P.chooesefile().then((e=>{B.value=[...P.filelist],l("update:modelValue",P.filelist)}))}return l("update:modelValue",L(i.defaultValue)),B.value=[...P.filelist],uni.$tm.u.deepClone(r(P.filelist)),u([()=>i.header,()=>i.maxFile,()=>i.maxSize,()=>i.formData],(()=>{P.setConfig({formName:i.formName,hostUrl:i.url,header:i.header,formData:i.formData,maxFile:i.maxFile,maxSize:i.maxSize})}),{deep:!0}),P.beforeChooesefile=async function(){if(P.setConfig({maxFile:i.maxFile-P.filelist.length}),"function"==typeof i.beforeChooese){let e=await i.beforeChooese();if("function"==typeof e&&(e=await e()),!e)return!1}return!0},P.chooesefileAfter=async function(e){let t=uni.$tm.u.deepClone(e);if("function"==typeof i.beforeChooese){let e=await i.beforeChooese(t);"function"==typeof e&&(e=await e(t))}return t},P.beforeSuccess=async function(e){if("function"==typeof i.onSuccessAfter){let t=await i.onSuccessAfter(e);if("function"==typeof t&&(t=await t(e)),!t)return!1}return!0},P.beforeStart=async function(e){if("function"==typeof i.onStart){let t=await i.onStart(e);if("function"==typeof t&&(t=await t(e)),!t)return!1}return!0},P.complete=function(e){B.value=[...P.filelist]},u((()=>i.modelValue),(()=>{clearTimeout(o);let e=C(i.modelValue)?r(i.modelValue):i.modelValue;o=setTimeout((function(){let t=Array.isArray(e)?e:[];if(P.clear(),0==t.length)P.filelist=[],B.value=[];else{let e=L(t);P.addFile(e);let l=uni.$tm.u.deepClone(P.filelist);B.value=[...l]}}),100)}),{deep:!0}),P.uploadComplete=function(e){l("uploadComplete",e),l("update:modelValue",P.filelist)},P.success=function(e,t){l("success",r(e),r(P.filelist)),l("change",r(P.filelist))},P.fail=function(e){l("success",r(e),r(P.filelist)),l("change",r(P.filelist))},t({start:()=>P.start(),stop:()=>P.stop(),clear:function(){P.clear(),P.filelist=[],B.value=[],l("update:modelValue",[])},del:function(e){let t=P.filelist.findIndex((t=>t.uid==e));if(t>-1){const e=P.filelist[t];P.delete(e),B.value=B.value.splice(t,1),l("remove",r(e)),l("update:modelValue",P.filelist),l("change",r(P.filelist))}},getFailList:function(){return P.filelist.filter((e=>e.statusCode!=N.fail&&e.statusCode!=N.max))},clearFail:function(){const e=P.filelist.filter((e=>e.statusCode!=N.fail&&e.statusCode!=N.max));B.value=[...e],l("update:modelValue",P.filelist)}}),(t,s)=>{const o=S;return f(),c(o,{class:"flex flex-col flex-col-top-start"},{default:d((()=>[p(o,{class:"flex flex-row flex-row-top-start relative",style:x([{"flex-wrap":"wrap"},{width:e.width+"rpx"}])},{default:d((()=>[(f(!0),m(y,null,h(B.value,((e,t)=>(f(),c(o,{class:"ma-5",key:t,style:x({width:g(T)-10+"rpx"})},{default:d((()=>[p(V,{round:2,color:i.color,text:"",transprent:!0,padding:[0,0],margin:[0,0],class:""},{default:d((()=>[p(k,{preview:"",round:2,allowDelete:!1,onDelete:t=>async function(e){if("function"==typeof i.onRemove){let t=await i.onRemove(e);if("function"==typeof t&&(t=await t(e)),!t)return!1}P.delete(e),B.value=[...P.filelist],l("remove",r(e)),l("update:modelValue",P.filelist),l("change",r(P.filelist))}(e),extra:"",delete:!g(U),src:e.url,width:g(T)-10,extraPosition:"in",height:g(D)-10,model:i.imageModel},{extra:d((()=>[!g(U)&&i.showStatus?(f(),c(o,{key:0,style:x({background:"rgba(0, 0, 0, 0.5)",width:g(T)-10+"rpx"}),class:F([["round-b-2"],"py-4 px-4 flex flex-row flex-row-center-start"])},{default:d((()=>[0==e.statusCode||1==e.statusCode?(f(),c(A,{key:0,"font-size":23,color:"grey-3",name:"tmicon-clock-fill"})):w("v-if",!0),0==e.statusCode||1==e.statusCode?(f(),c(z,{key:1,color:"grey-3",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):w("v-if",!0),2==e.statusCode||4==e.statusCode?(f(),c(A,{key:2,"font-size":23,color:"red",name:"tmicon-times-circle-fill"})):w("v-if",!0),2==e.statusCode||4==e.statusCode?(f(),c(z,{key:3,color:"red",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):w("v-if",!0),3==e.statusCode?(f(),c(A,{key:4,"font-size":23,color:"green",name:"tmicon-check-circle-fill"})):w("v-if",!0),3==e.statusCode?(f(),c(z,{key:5,color:"green",_class:"pl-5","font-size":23,label:e.status},null,8,["label"])):w("v-if",!0)])),_:2},1032,["style"])):w("v-if",!0),i.showSort?(f(),c(o,{key:1,class:"absolute l-0 t-0 flex flex-row flex-row-center-between flex-1",style:x({width:g(T)-10+"rpx",height:"44rpx",top:(g(D)-44)/2+"rpx"})},{default:d((()=>[p(o,{onClick:_((e=>E(0,t,"prev")),["stop"]),class:F([[0==t?"opacity-0":""],"flex flex-row flex-row-center-center px-12 py-4 round-tr-12 round-br-12"]),style:x({background:"rgba(0, 0, 0, 0.5)"})},{default:d((()=>[p(A,{userInteractionEnabled:!1,color:"white","font-size":22,name:"tmicon-angle-left"})])),_:2},1032,["onClick","class","style"]),p(o,{onClick:_((e=>E(0,t,"next")),["stop"]),class:F([[t==B.value.length-1?"opacity-0":""],"flex flex-row flex-row-center-center px-12 py-4 round-tl-12 round-bl-12"]),style:x({background:"rgba(0, 0, 0, 0.5)"})},{default:d((()=>[p(A,{userInteractionEnabled:!1,color:"white","font-size":22,name:"tmicon-angle-right"})])),_:2},1032,["onClick","class","style"])])),_:2},1032,["style"])):w("v-if",!0)])),_:2},1032,["onDelete","delete","src","width","height","model"])])),_:2},1032,["color"])])),_:2},1032,["style"])))),128)),g(I)?w("v-if",!0):(f(),c(o,{key:0,onClick:$,class:"ma-5",style:x({width:g(T)-10+"rpx"})},{default:d((()=>[p(V,{eventPenetrationEnabled:!0,followTheme:i.followTheme,round:2,color:i.color,text:"",padding:[0,0],margin:[0,0],_class:"flex-center",height:g(D)-10},{default:d((()=>[v(t.$slots,"icon",{},(()=>[p(A,{"font-size":42,userInteractionEnabled:!1,name:"tmicon-plus"})]))])),_:3},8,["followTheme","color","height"])])),_:3},8,["style"]))])),_:3},8,["style"])])),_:3})}}});export{D as _};
